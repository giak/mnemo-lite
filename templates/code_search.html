{% extends "base.html" %}

{% block title %}Code Search - MnemoLite{% endblock %}
{% block nav_code %}active{% endblock %}
{% block nav_code_search %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üîç Code Search</h1>
    <p class="subtitle">Search indexed code with hybrid/lexical/vector modes</p>
</div>

<div class="search-box">
    <form id="search-form"
          hx-get="/ui/code/search/results"
          hx-target="#code-results"
          hx-trigger="submit"
          hx-indicator="#search-loading">

        <div class="search-input-group">
            <input type="text"
                   name="q"
                   id="search-query"
                   placeholder="Enter search query (e.g., 'function to calculate totals')..."
                   class="search-input"
                   autofocus>
            <button type="submit" class="btn btn-primary">
                Search
            </button>
        </div>
    </form>

    <div id="search-loading" class="htmx-indicator">
        <span class="spinner"></span> Searching...
    </div>
</div>

<!-- Search Mode & Filters -->
<div class="filters-bar">
    <form id="filters-form"
          hx-get="/ui/code/search/results"
          hx-target="#code-results"
          hx-trigger="change from:find input, change from:find select"
          hx-include="#search-query">

        <!-- Search Mode (Radio Buttons) -->
        <div class="filter-group">
            <label class="filter-label">Search Mode</label>
            <div class="search-mode-buttons">
                <label class="mode-btn active">
                    <input type="radio" name="mode" value="hybrid" checked>
                    <span>Hybrid (RRF)</span>
                </label>
                <label class="mode-btn">
                    <input type="radio" name="mode" value="lexical">
                    <span>Lexical</span>
                </label>
                <label class="mode-btn">
                    <input type="radio" name="mode" value="vector">
                    <span>Vector</span>
                </label>
            </div>
        </div>

        <!-- Filters Grid -->
        <div class="filters-grid">
            <!-- Repository Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-repository">Repository</label>
                <select name="repository" id="filter-repository" class="filter-select">
                    <option value="">All Repositories</option>
                    <!-- Populated dynamically via HTMX -->
                </select>
            </div>

            <!-- Language Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-language">Language</label>
                <select name="language" id="filter-language" class="filter-select">
                    <option value="">All Languages</option>
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="typescript">TypeScript</option>
                    <option value="java">Java</option>
                    <option value="go">Go</option>
                    <option value="rust">Rust</option>
                    <option value="cpp">C++</option>
                    <option value="c">C</option>
                </select>
            </div>

            <!-- Chunk Type Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-chunk-type">Type</label>
                <select name="chunk_type" id="filter-chunk-type" class="filter-select">
                    <option value="">All Types</option>
                    <option value="function">Function</option>
                    <option value="class">Class</option>
                    <option value="method">Method</option>
                </select>
            </div>

            <!-- Limit Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-limit">Results</label>
                <select name="limit" id="filter-limit" class="filter-select">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
            <button type="button" class="btn btn-clear" onclick="clearCodeFilters()">Clear Filters</button>
            <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
    </form>
</div>

<div id="code-results" class="search-results">
    <!-- Results will be loaded here via HTMX -->
    <div class="empty-state">
        <p>Enter a search query to find code</p>
        <p class="text-muted">üí° Hybrid mode combines lexical + vector search with RRF fusion</p>
    </div>
</div>

<script>
// Search Mode Radio Button Toggle
document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[name="mode"]');
    const modeButtons = document.querySelectorAll('.mode-btn');

    radioButtons.forEach((radio, index) => {
        radio.addEventListener('change', function() {
            modeButtons.forEach(btn => btn.classList.remove('active'));
            if (this.checked) {
                modeButtons[index].classList.add('active');
            }
        });
    });
});

// Clear Code Filters
function clearCodeFilters() {
    // Reset search mode to hybrid
    document.querySelector('input[name="mode"][value="hybrid"]').checked = true;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.mode-btn').classList.add('active');

    // Reset filters
    document.getElementById('filter-repository').value = '';
    document.getElementById('filter-language').value = '';
    document.getElementById('filter-chunk-type').value = '';
    document.getElementById('filter-limit').value = '20';

    // Clear results
    document.getElementById('code-results').innerHTML = `
        <div class="empty-state">
            <p>Enter a search query to find code</p>
            <p class="text-muted">üí° Hybrid mode combines lexical + vector search with RRF fusion</p>
        </div>
    `;
}

// Load repository options dynamically
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/v1/code/index/repositories');
        const data = await response.json();

        const select = document.getElementById('filter-repository');
        data.repositories.forEach(repo => {
            const option = document.createElement('option');
            option.value = repo.repository;
            option.textContent = repo.repository;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load repositories:', error);
    }
});
</script>

<style>
/* Search Mode Radio Buttons - SCADA Style */
.search-mode-buttons {
    display: flex;
    gap: var(--space-sm);
}

.mode-btn {
    position: relative;
    padding: var(--space-lg) var(--space-xl);
    font-size: var(--text-tiny);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-dim);
    background-color: var(--color-bg-input);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition);
    font-family: var(--font-mono);
}

.mode-btn input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.mode-btn:hover {
    border-color: var(--color-accent-blue);
    color: var(--color-accent-blue);
}

.mode-btn.active {
    border-color: var(--color-accent-blue);
    background-color: rgba(74, 144, 226, 0.12);
    color: var(--color-accent-blue);
    font-weight: 700;
}

/* Code Results Styles */
.code-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-accent-green);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
    transition: all var(--transition);
    cursor: pointer;
}

.code-card:hover {
    border-left-color: var(--color-accent-blue);
    background: var(--color-bg-elevated);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--color-border-subtle);
}

.code-name {
    font-size: var(--text-md);
    font-weight: 700;
    color: var(--color-accent-green);
    font-family: 'SF Mono', Consolas, monospace;
}

.code-score {
    font-size: var(--text-xs);
    font-weight: 600;
    padding: 2px 8px;
    background: rgba(74, 144, 226, 0.12);
    border: 1px solid rgba(74, 144, 226, 0.3);
    border-radius: var(--radius-sm);
    color: var(--color-accent-blue);
}

.code-path {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    font-family: 'SF Mono', Consolas, monospace;
    margin-bottom: var(--space-md);
}

.code-snippet {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
    font-family: 'SF Mono', Consolas, monospace;
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
}

.code-metadata {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-md);
}

.code-metadata .badge {
    font-size: var(--text-tiny);
    font-weight: 600;
    padding: 2px 6px;
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
</style>
{% endblock %}
