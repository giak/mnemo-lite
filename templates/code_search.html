{% extends "base.html" %}

{% block title %}Code Search - MnemoLite{% endblock %}
{% block nav_code %}active{% endblock %}
{% block nav_code_search %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üîç Code Search</h1>
    <p class="subtitle">Search indexed code with hybrid/lexical/vector modes</p>
</div>

<!-- Unified Form (HTMX requires inputs INSIDE form) -->
<form id="unified-search-form"
      hx-get="/ui/code/search/results"
      hx-target="#code-results"
      hx-trigger="submit, change from:find input[type='radio'], change from:find select"
      hx-indicator="#search-loading">

    <!-- Search Box (inside form for HTMX) -->
    <div class="search-box">
        <div class="search-input-group">
            <input type="text"
                   name="q"
                   id="search-query"
                   placeholder="Enter search query (e.g., 'function to calculate totals')..."
                   class="search-input"
                   autofocus>
            <button type="submit" class="btn btn-primary">
                Search
            </button>
        </div>

        <div id="search-loading" class="htmx-indicator">
            <span class="spinner"></span> Searching...
        </div>
    </div>

    <!-- Search Mode & Filters -->
    <div class="filters-bar">
        <!-- Search Mode (Radio Buttons) -->
        <div class="filter-group">
            <label class="filter-label">Search Mode</label>
            <div class="search-mode-buttons">
                <label class="mode-btn">
                    <input type="radio" name="mode" value="hybrid">
                    <span>Hybrid (RRF)</span>
                </label>
                <label class="mode-btn active">
                    <input type="radio" name="mode" value="lexical" checked>
                    <span>Lexical</span>
                </label>
                <label class="mode-btn">
                    <input type="radio" name="mode" value="vector">
                    <span>Vector</span>
                </label>
            </div>
        </div>

        <!-- Filters Grid -->
        <div class="filters-grid">
            <!-- Repository Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-repository">Repository</label>
                <select name="repository" id="filter-repository" class="filter-select">
                    <option value="">All Repositories</option>
                    <!-- Populated dynamically via HTMX -->
                </select>
            </div>

            <!-- Language Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-language">Language</label>
                <select name="language" id="filter-language" class="filter-select">
                    <option value="">All Languages</option>
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="typescript">TypeScript</option>
                    <option value="java">Java</option>
                    <option value="go">Go</option>
                    <option value="rust">Rust</option>
                    <option value="cpp">C++</option>
                    <option value="c">C</option>
                </select>
            </div>

            <!-- Chunk Type Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-chunk-type">Type</label>
                <select name="chunk_type" id="filter-chunk-type" class="filter-select">
                    <option value="">All Types</option>
                    <option value="function">Function</option>
                    <option value="class">Class</option>
                    <option value="method">Method</option>
                </select>
            </div>

            <!-- EPIC-14 Story 14.4: Return Type Filter (with autocomplete) -->
            <div class="filter-group">
                <label class="filter-label" for="filter-return-type">Return Type</label>
                <input type="text"
                       name="return_type"
                       id="filter-return-type"
                       class="filter-input autocomplete-input"
                       placeholder="e.g., str, User, List[int]">
            </div>

            <!-- EPIC-14 Story 14.4: Parameter Type Filter (with autocomplete) -->
            <div class="filter-group">
                <label class="filter-label" for="filter-param-type">Param Type</label>
                <input type="text"
                       name="param_type"
                       id="filter-param-type"
                       class="filter-input autocomplete-input"
                       placeholder="e.g., int, str, Dict">
            </div>

            <!-- Limit Filter -->
            <div class="filter-group">
                <label class="filter-label" for="filter-limit">Results</label>
                <select name="limit" id="filter-limit" class="filter-select">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
            <button type="button" class="btn btn-clear" onclick="clearCodeFilters()">Clear Filters</button>
            <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
    </div>
    <!-- End filters-bar -->

</form>
<!-- End unified-search-form -->

<div id="code-results" class="search-results">
    <!-- Results will be loaded here via HTMX -->
    <div class="empty-state">
        <p>Enter a search query to find code</p>
        <p class="text-muted">üí° Lexical mode uses PostgreSQL full-text search (BM25)</p>
    </div>
</div>

<script>
// Search Mode Radio Button Toggle
document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[name="mode"]');
    const modeButtons = document.querySelectorAll('.mode-btn');

    radioButtons.forEach((radio, index) => {
        radio.addEventListener('change', function() {
            modeButtons.forEach(btn => btn.classList.remove('active'));
            if (this.checked) {
                modeButtons[index].classList.add('active');
            }
        });
    });
});

// Clear Code Filters
function clearCodeFilters() {
    // Reset search query
    document.getElementById('search-query').value = '';

    // Reset search mode to lexical (default)
    document.querySelector('input[name="mode"][value="lexical"]').checked = true;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.mode-btn')[1].classList.add('active'); // LEXICAL is 2nd button

    // Reset filters
    document.getElementById('filter-repository').value = '';
    document.getElementById('filter-language').value = '';
    document.getElementById('filter-chunk-type').value = '';
    document.getElementById('filter-return-type').value = '';  // EPIC-14 Story 14.4
    document.getElementById('filter-param-type').value = '';   // EPIC-14 Story 14.4
    document.getElementById('filter-limit').value = '20';

    // Clear results
    document.getElementById('code-results').innerHTML = `
        <div class="empty-state">
            <p>Enter a search query to find code</p>
            <p class="text-muted">üí° Lexical mode uses PostgreSQL full-text search (BM25)</p>
        </div>
    `;
}

// EPIC-21 Story 21.3: Toggle Code Snippet Expand/Collapse
function toggleCodeSnippet(button) {
    console.log('[EPIC-21] toggleCodeSnippet() called', button);

    const container = button.parentElement;
    console.log('[EPIC-21] Container:', container);

    const snippet = container.querySelector('.code-snippet');
    console.log('[EPIC-21] Snippet element:', snippet);
    console.log('[EPIC-21] Snippet classes:', snippet ? snippet.className : 'SNIPPET NOT FOUND');

    const toggleText = button.querySelector('.toggle-text');

    if (snippet.classList.contains('collapsed')) {
        // Expand
        console.log('[EPIC-21] Expanding code snippet');
        snippet.classList.remove('collapsed');
        button.classList.add('expanded');
        toggleText.textContent = 'Hide Code';
        button.setAttribute('aria-label', 'Collapse code');

        // Trigger Prism.js highlighting after expand (EPIC-21 Story 21.2)
        if (window.Prism) {
            console.log('[EPIC-21] Triggering Prism.js highlighting');
            Prism.highlightAllUnder(snippet);
        } else {
            console.warn('[EPIC-21] Prism.js not loaded!');
        }
    } else {
        // Collapse
        console.log('[EPIC-21] Collapsing code snippet');
        snippet.classList.add('collapsed');
        button.classList.remove('expanded');
        toggleText.textContent = 'Show Code';
        button.setAttribute('aria-label', 'Expand code');
    }

    console.log('[EPIC-21] Toggle complete, new classes:', snippet.className);
}

// EPIC-21 Story 21.3 & 21.4: Log when page loads
console.log('[EPIC-21] Code search page loaded - toggleCodeSnippet function available:', typeof toggleCodeSnippet);

// EPIC-21 Story 21.4: Setup copy buttons after HTMX swap
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'code-results') {
        console.log('[EPIC-21] Story 21.4: HTMX afterSwap fired for #code-results');

        // Re-trigger search results manager setup
        if (window.searchResultsManager) {
            console.log('[EPIC-21] Story 21.4: Calling searchResultsManager.setup()');
            window.searchResultsManager.setup();
        } else {
            console.warn('[EPIC-21] Story 21.4: searchResultsManager not available!');
        }

        // Debug copy buttons
        const copyButtons = evt.detail.target.querySelectorAll('.copy-btn');
        console.log('[EPIC-21] Story 21.4: Found', copyButtons.length, 'copy buttons');
        copyButtons.forEach((btn, i) => {
            const dataCopy = btn.getAttribute('data-copy');
            console.log(`[EPIC-21] Story 21.4: Button ${i} data-copy length:`, dataCopy ? dataCopy.length : 'NULL');
        });
    }
});

// Load repository options dynamically
document.addEventListener('DOMContentLoaded', async function() {
    console.log('[EPIC-21] DOMContentLoaded fired');

    try {
        const response = await fetch('/v1/code/index/repositories');
        const data = await response.json();

        const select = document.getElementById('filter-repository');
        data.repositories.forEach(repo => {
            const option = document.createElement('option');
            option.value = repo.repository;
            option.textContent = repo.repository;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load repositories:', error);
    }
});
</script>

<!-- EPIC-14: HTML Utilities for XSS Prevention -->
<script src="/static/js/utils/html_utils.js"></script>

<!-- EPIC-14 Story 14.1: Enhanced Search Results JavaScript -->
<script src="/static/js/components/search_results.js"></script>

<!-- EPIC-14 Story 14.4: Autocomplete JavaScript -->
<script src="/static/js/components/autocomplete.js"></script>

<!-- EPIC-14 Story 14.4: Initialize Autocomplete for Type Filters -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize autocomplete for return_type filter
    const returnTypeInput = document.getElementById('filter-return-type');
    if (returnTypeInput) {
        new Autocomplete(returnTypeInput, {
            field: 'return_type',
            placeholder: 'e.g., str, User, List[int]',
            minChars: 1,
            debounceDelay: 300,
            onSelect: (suggestion) => {
                console.log('[Autocomplete] Return type selected:', suggestion.value);
                // Trigger HTMX search
                document.getElementById('unified-search-form').dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    }

    // Initialize autocomplete for param_type filter
    const paramTypeInput = document.getElementById('filter-param-type');
    if (paramTypeInput) {
        new Autocomplete(paramTypeInput, {
            field: 'param_type',
            placeholder: 'e.g., int, str, Dict',
            minChars: 1,
            debounceDelay: 300,
            onSelect: (suggestion) => {
                console.log('[Autocomplete] Param type selected:', suggestion.value);
                // Trigger HTMX search
                document.getElementById('unified-search-form').dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    }
});
</script>

<style>
/* Search Mode Radio Buttons - SCADA Style */
.search-mode-buttons {
    display: flex;
    gap: var(--space-sm);
}

.mode-btn {
    position: relative;
    padding: var(--space-lg) var(--space-xl);
    font-size: var(--text-tiny);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-dim);
    background-color: var(--color-bg-input);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition);
    font-family: var(--font-mono);
}

.mode-btn input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.mode-btn:hover {
    border-color: var(--color-accent-blue);
    color: var(--color-accent-blue);
}

.mode-btn.active {
    border-color: var(--color-accent-blue);
    background-color: rgba(74, 144, 226, 0.12);
    color: var(--color-accent-blue);
    font-weight: 700;
}

/* Code Results Styles */
.code-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-accent-green);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
    transition: all var(--transition);
    cursor: pointer;
}

.code-card:hover {
    border-left-color: var(--color-accent-blue);
    background: var(--color-bg-elevated);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--color-border-subtle);
}

.code-name {
    font-size: var(--text-md);
    font-weight: 700;
    color: var(--color-accent-green);
    font-family: 'SF Mono', Consolas, monospace;
}

.code-score {
    font-size: var(--text-xs);
    font-weight: 600;
    padding: 2px 8px;
    background: rgba(74, 144, 226, 0.12);
    border: 1px solid rgba(74, 144, 226, 0.3);
    border-radius: var(--radius-sm);
    color: var(--color-accent-blue);
}

.code-path {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    font-family: 'SF Mono', Consolas, monospace;
    margin-bottom: var(--space-md);
}

.code-snippet {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
    font-family: 'SF Mono', Consolas, monospace;
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
}

.code-metadata {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-md);
}

.code-metadata .badge {
    font-size: var(--text-tiny);
    font-weight: 600;
    padding: 2px 6px;
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* EPIC-14 Story 14.4: Autocomplete Input Styles */
.filter-input.autocomplete-input {
    width: 100%;
    padding: var(--space-md);
    font-size: var(--text-sm);
    font-family: var(--font-mono);
    color: var(--color-text-primary);
    background: var(--color-bg-input);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    transition: all var(--transition);
}

.filter-input.autocomplete-input:focus {
    outline: none;
    border-color: var(--color-accent-blue);
    background: var(--color-bg-elevated);
}

.filter-input.autocomplete-input::placeholder {
    color: var(--color-text-dim);
    font-style: italic;
}

/* EPIC-21 Story 21.3: Collapsible Code Cards */
.code-snippet-container {
    margin-top: var(--space-md);
}

.code-toggle-btn {
    display: flex !important;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-sm);
    background: var(--color-bg-panel) !important;
    border: 1px solid var(--color-border) !important;
    border-radius: var(--radius-sm);
    color: var(--color-accent-blue) !important;
    font-size: var(--text-xs);
    font-weight: 600;
    font-family: var(--font-mono);
    cursor: pointer !important;
    transition: all var(--transition);
    width: 100%;
    text-align: left;
    visibility: visible !important;
    opacity: 1 !important;
}

.code-toggle-btn:hover {
    background: var(--color-bg-elevated);
    border-color: var(--color-accent-blue);
}

.code-toggle-btn .toggle-icon {
    font-size: var(--text-sm);
    transition: transform 0.3s ease;
}

.code-toggle-btn.expanded .toggle-icon {
    transform: rotate(180deg);
}

.code-snippet.collapsed {
    max-height: 120px !important; /* ~5 lines of code */
    overflow: hidden !important;
    position: relative;
}

.code-snippet.collapsed::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: linear-gradient(to bottom, transparent, var(--color-bg-panel));
    pointer-events: none;
}

.code-snippet {
    transition: max-height 0.3s ease-in-out;
}

.code-snippet:not(.collapsed) {
    max-height: 600px !important; /* Expanded height */
    overflow-y: auto !important;
}
</style>
{% endblock %}
