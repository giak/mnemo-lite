{% extends "base.html" %}

{% block title %}Auto-Save Monitoring - MnemoLite{% endblock %}

{% block extra_head %}
<style>
/* SCADA Industrial Observability Design - Auto-Save Dashboard */

.autosave-container {
    padding: var(--space-3xl);
    min-height: calc(100vh - 180px);
}

/* Status Banner */
.status-banner {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-left: 4px solid var(--color-ok);
    padding: var(--space-2xl) var(--space-3xl);
    margin-bottom: var(--space-3xl);
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-left-color var(--transition);
}

.status-info {
    display: flex;
    align-items: center;
    gap: var(--space-2xl);
}

.status-indicator {
    font-size: var(--text-3xl);
    line-height: var(--leading-none);
}

.status-text h1 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--text-xl);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-primary);
}

.status-text p {
    margin: 0;
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    font-family: var(--font-mono);
}

.refresh-control {
    display: flex;
    align-items: center;
    gap: var(--space-xl);
}

.auto-refresh-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
}

.auto-refresh-toggle input[type="checkbox"] {
    width: 16px;
    height: 16px;
}

.refresh-btn {
    background: var(--color-bg-input);
    border: 1px solid var(--color-border);
    color: var(--color-info);
    padding: var(--space-lg) var(--space-2xl);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: border-color var(--transition);
}

.refresh-btn:hover:not(:disabled) {
    border-color: var(--color-info);
}

.refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* KPI Cards Grid */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-2xl);
    margin-bottom: var(--space-3xl);
}

.kpi-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-top: 2px solid var(--color-border-subtle);
    padding: var(--space-2xl);
    transition: border-top-color var(--transition);
}

.kpi-card.success { border-top-color: var(--color-ok); }
.kpi-card.warning { border-top-color: var(--color-warning); }
.kpi-card.info { border-top-color: var(--color-info); }
.kpi-card.metric { border-top-color: var(--color-text-dim); }

.kpi-label {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-lg);
}

.kpi-value {
    font-family: var(--font-mono);
    font-size: var(--text-3xl);
    font-weight: 700;
    line-height: var(--leading-none);
    color: var(--color-accent-cyan);
    letter-spacing: -0.02em;
    margin-bottom: var(--space-md);
}

.kpi-change {
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
}

.daemon-status {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    margin-top: var(--space-md);
}

.status-dot {
    width: 8px;
    height: 8px;
    background: var(--color-ok);
    animation: pulse 2s infinite;
}

.status-dot.running { background: var(--color-ok); }
.status-dot.stopped { background: var(--color-critical); }
.status-dot.unknown { background: var(--color-warning); }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* Chart Panel */
.chart-panel {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    padding: var(--space-2xl);
    margin-bottom: var(--space-3xl);
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border-subtle);
}

.panel-header h2 {
    margin: 0;
    font-size: var(--text-md);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-primary);
}

.panel-meta {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    font-family: var(--font-mono);
}

.timeline-bars {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    height: 180px;
    gap: var(--space-md);
    margin-top: var(--space-2xl);
}

.timeline-bar {
    flex: 1;
    background: linear-gradient(180deg, var(--color-info) 0%, var(--color-accent-blue) 100%);
    position: relative;
    transition: all var(--transition);
    min-height: 2px;
}

.timeline-bar:hover {
    opacity: 0.8;
}

.timeline-bar-label {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--text-tiny);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
    white-space: nowrap;
}

.timeline-bar-value {
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--text-xs);
    font-weight: 700;
    color: var(--color-text-secondary);
    font-family: var(--font-mono);
}

/* Conversations List */
.conversations-panel {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    padding: var(--space-2xl);
}

.conversation-item {
    padding: var(--space-2xl);
    border-bottom: 1px solid var(--color-border-subtle);
    transition: background-color var(--transition);
}

.conversation-item:hover {
    background: var(--color-bg-elevated);
}

.conversation-item:last-child {
    border-bottom: none;
}

.conversation-title {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    margin-bottom: var(--space-md);
    line-height: var(--leading-snug);
}

.conversation-meta {
    display: flex;
    gap: var(--space-2xl);
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
    margin-bottom: var(--space-md);
}

.conversation-tags {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
}

.tag {
    font-size: var(--text-tiny);
    font-weight: 600;
    padding: 3px 6px;
    background: var(--color-bg-input);
    color: var(--color-text-dim);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.tag.session { background: rgba(52, 152, 219, 0.15); color: var(--color-info); }
.tag.date { background: rgba(255, 165, 2, 0.15); color: var(--color-warning); }

.empty-state {
    text-align: center;
    padding: var(--space-3xl);
    color: var(--color-text-tertiary);
}

.loading-spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-info);
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 1000;
    overflow-y: auto;
}

.modal-overlay.active {
    display: block;
}

.modal-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: var(--space-3xl);
}

.modal-content {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    padding: var(--space-3xl);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-3xl);
    padding-bottom: var(--space-2xl);
    border-bottom: 1px solid var(--color-border-subtle);
}

.modal-title {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
}

.modal-close {
    background: var(--color-bg-input);
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
    padding: var(--space-md) var(--space-xl);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: border-color var(--transition);
}

.modal-close:hover {
    border-color: var(--color-critical);
    color: var(--color-critical);
}

.modal-body {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    line-height: var(--leading-normal);
    max-height: 70vh;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.modal-body h2 {
    color: var(--color-text-primary);
    font-size: var(--text-md);
    font-weight: 600;
    margin: var(--space-3xl) 0 var(--space-xl) 0;
    padding: var(--space-2xl);
    background: var(--color-bg-elevated);
    border-left: 3px solid var(--color-accent-cyan);
}

.modal-body h2:first-child {
    margin-top: 0;
}

.modal-body p {
    margin: var(--space-lg) 0;
}

.modal-body pre, .modal-body code {
    background: var(--color-bg-input);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
}

.modal-body pre {
    padding: var(--space-2xl);
    overflow-x: auto;
    border: 1px solid var(--color-border-subtle);
}

.modal-body code {
    padding: 2px 6px;
}

.conversation-item {
    cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
<div class="autosave-container">
    <!-- Status Banner -->
    <div class="status-banner">
        <div class="status-info">
            <div class="status-indicator">🤖</div>
            <div class="status-text">
                <h1>Auto-Save Monitoring</h1>
                <p>CLAUDE CODE CONVERSATIONS → POSTGRESQL MEMORY</p>
            </div>
        </div>
        <div class="refresh-control">
            <div class="auto-refresh-toggle">
                <input type="checkbox" id="auto-refresh" checked>
                <label for="auto-refresh">AUTO-REFRESH (30S)</label>
            </div>
            <button class="refresh-btn" onclick="refreshDashboard()">
                <span id="refresh-icon">⟳</span> REFRESH
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card success">
            <div class="kpi-label">Total Conversations</div>
            <div class="kpi-value" id="stat-total">---</div>
            <div class="daemon-status">
                <div class="status-dot running" id="daemon-status-dot"></div>
                <span class="kpi-change" id="daemon-status-text">DAEMON RUNNING</span>
            </div>
        </div>

        <div class="kpi-card info">
            <div class="kpi-label">Last 24 Hours</div>
            <div class="kpi-value" id="stat-24h">---</div>
            <div class="kpi-change" id="stat-24h-change">---</div>
        </div>

        <div class="kpi-card info">
            <div class="kpi-label">Last 7 Days</div>
            <div class="kpi-value" id="stat-7d">---</div>
            <div class="kpi-change" id="stat-7d-pct">---</div>
        </div>

        <div class="kpi-card success">
            <div class="kpi-label">Embedding Coverage</div>
            <div class="kpi-value" id="stat-embeddings">---</div>
            <div class="kpi-change" id="stat-embeddings-pct">---</div>
        </div>
    </div>

    <!-- Timeline Chart -->
    <div class="chart-panel">
        <div class="panel-header">
            <h2>Import Timeline (7 Days)</h2>
            <span class="panel-meta" id="timeline-total">---</span>
        </div>
        <div class="timeline-bars" id="timeline-chart">
            <div class="empty-state">Loading timeline...</div>
        </div>
    </div>

    <!-- Recent Conversations -->
    <div class="conversations-panel">
        <div class="panel-header">
            <h2>Recent Conversations</h2>
            <span class="panel-meta" id="recent-count">---</span>
        </div>
        <div id="conversations-container">
            <div class="empty-state">Loading conversations...</div>
        </div>
    </div>
</div>

<!-- Modal for conversation content -->
<div class="modal-overlay" id="conversation-modal">
    <div class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="modal-title">Conversation</h1>
                <button class="modal-close" onclick="closeConversationModal()">✕ CLOSE</button>
            </div>
            <div class="modal-body" id="modal-body">
                Loading...
            </div>
        </div>
    </div>
</div>

<script>
let autoRefreshInterval;

async function fetchStats() {
    try {
        const response = await fetch('/v1/autosave/stats');
        const data = await response.json();

        document.getElementById('stat-total').textContent = data.total_conversations.toLocaleString();
        document.getElementById('stat-24h').textContent = data.last_24_hours.toLocaleString();
        document.getElementById('stat-7d').textContent = data.last_7_days.toLocaleString();
        document.getElementById('stat-embeddings').textContent = data.with_embeddings.toLocaleString();
        document.getElementById('stat-embeddings-pct').textContent = `${data.embedding_coverage_pct}% coverage`;

        // Last import info
        if (data.last_import_at) {
            const lastImport = new Date(data.last_import_at);
            const ago = data.last_import_ago || 'just now';
            document.getElementById('stat-24h-change').textContent = `LAST: ${ago.split('.')[0]} AGO`;
        }

        // Daemon status
        await fetchDaemonStatus();
    } catch (error) {
        console.error('Error fetching stats:', error);
    }
}

async function fetchDaemonStatus() {
    try {
        const response = await fetch('/v1/autosave/daemon-status');
        const data = await response.json();

        const statusDot = document.getElementById('daemon-status-dot');
        const statusText = document.getElementById('daemon-status-text');

        if (data.status === 'running') {
            statusDot.className = 'status-dot running';
            const ago = data.last_activity_ago ? data.last_activity_ago.split('.')[0] : 'unknown';
            statusText.textContent = `ACTIVE (${ago} AGO)`;
        } else if (data.status === 'unknown') {
            statusDot.className = 'status-dot unknown';
            statusText.textContent = 'STATUS UNKNOWN';
        } else {
            statusDot.className = 'status-dot stopped';
            statusText.textContent = 'STOPPED';
        }
    } catch (error) {
        console.error('Error fetching daemon status:', error);
    }
}

async function fetchTimeline() {
    try {
        const response = await fetch('/v1/autosave/timeline?days=7');
        const data = await response.json();

        const container = document.getElementById('timeline-chart');
        const total = data.reduce((sum, item) => sum + item.count, 0);
        document.getElementById('timeline-total').textContent = `TOTAL: ${total.toLocaleString()} CONVERSATIONS`;

        if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">NO DATA AVAILABLE</div>';
            return;
        }

        const maxCount = Math.max(...data.map(item => item.count));

        container.innerHTML = data.reverse().map(item => {
            const height = (item.count / maxCount) * 100;
            const date = new Date(item.date);
            const dateLabel = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            return `
                <div class="timeline-bar" style="height: ${height}%;" title="${item.count} conversations on ${dateLabel}">
                    <div class="timeline-bar-value">${item.count}</div>
                    <div class="timeline-bar-label">${dateLabel}</div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error fetching timeline:', error);
    }
}

async function fetchRecentConversations() {
    try {
        const response = await fetch('/v1/autosave/recent?limit=10');
        const data = await response.json();

        const container = document.getElementById('conversations-container');
        document.getElementById('recent-count').textContent = `${data.length} MOST RECENT`;

        if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">NO CONVERSATIONS YET</div>';
            return;
        }

        container.innerHTML = data.map(conv => {
            const createdAgo = conv.created_ago.split('.')[0];
            const sessionTag = conv.tags.find(t => t.startsWith('session:'));
            const dateTag = conv.tags.find(t => t.startsWith('date:'));

            return `
                <div class="conversation-item" onclick="openConversationModal('${conv.id}', '${escapeHtml(conv.title)}')">
                    <div class="conversation-title">${escapeHtml(conv.title)}</div>
                    <div class="conversation-meta">
                        <span>⏰ ${createdAgo} ago</span>
                    </div>
                    <div class="conversation-tags">
                        <span class="tag">AUTO-IMPORT</span>
                        <span class="tag">CLAUDE-CODE</span>
                        ${sessionTag ? `<span class="tag session">${sessionTag.toUpperCase()}</span>` : ''}
                        ${dateTag ? `<span class="tag date">${dateTag.toUpperCase()}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error fetching conversations:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function refreshDashboard() {
    const button = document.querySelector('.refresh-btn');
    const icon = document.getElementById('refresh-icon');

    button.disabled = true;
    icon.innerHTML = '<span class="loading-spinner"></span>';

    try {
        await Promise.all([
            fetchStats(),
            fetchTimeline(),
            fetchRecentConversations()
        ]);
    } finally {
        setTimeout(() => {
            button.disabled = false;
            icon.textContent = '⟳';
        }, 1000);
    }
}

function setupAutoRefresh() {
    const checkbox = document.getElementById('auto-refresh');

    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(refreshDashboard, 30000);
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });

    if (checkbox.checked) {
        startAutoRefresh();
    }
}

// Modal functions
async function openConversationModal(conversationId, title) {
    const modal = document.getElementById('conversation-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');

    // Show modal
    modal.classList.add('active');
    modalTitle.textContent = title;
    modalBody.innerHTML = '<div class="empty-state">LOADING CONVERSATION...</div>';

    try {
        const response = await fetch(`/v1/autosave/conversation/${conversationId}`);
        const data = await response.json();

        if (data.error) {
            modalBody.innerHTML = `<div class="empty-state">ERROR: ${data.error.toUpperCase()}</div>`;
            return;
        }

        // Split content by sections and render each one
        const sections = data.content.split(/(?=## 👤 User)|(?=## 🤖 Claude)/);

        modalBody.innerHTML = sections.map(section => {
            if (section.startsWith('## 👤 User')) {
                return '<h2>👤 USER</h2>' + escapeHtml(section.replace('## 👤 User', ''));
            } else if (section.startsWith('## 🤖 Claude')) {
                return '<h2>🤖 CLAUDE</h2>' + escapeHtml(section.replace('## 🤖 Claude', ''));
            } else {
                return escapeHtml(section);
            }
        }).join('');
    } catch (error) {
        console.error('Error loading conversation:', error);
        modalBody.innerHTML = '<div class="empty-state">ERROR LOADING CONVERSATION</div>';
    }
}

function closeConversationModal() {
    const modal = document.getElementById('conversation-modal');
    modal.classList.remove('active');
}

// Close modal on overlay click
document.getElementById('conversation-modal').addEventListener('click', (e) => {
    if (e.target.id === 'conversation-modal') {
        closeConversationModal();
    }
});

// Close modal on ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeConversationModal();
    }
});

// Initial load
document.addEventListener('DOMContentLoaded', () => {
    refreshDashboard();
    setupAutoRefresh();
});
</script>
{% endblock %}
