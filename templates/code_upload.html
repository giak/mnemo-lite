{% extends "base.html" %}

{% block title %}Code Upload - MnemoLite{% endblock %}
{% block nav_code %}active{% endblock %}
{% block nav_code_upload %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>📤 Code Upload</h1>
    <p class="subtitle">Upload code files for indexing</p>
</div>

<!-- Repository Configuration -->
<div class="upload-config">
    <div class="config-row">
        <label for="repository-name" class="config-label">Repository Name *</label>
        <input type="text"
               id="repository-name"
               class="config-input"
               placeholder="my-project"
               value=""
               required>
    </div>
    <div class="config-row">
        <label for="commit-hash" class="config-label">Commit Hash (optional)</label>
        <input type="text"
               id="commit-hash"
               class="config-input"
               placeholder="abc123def456">
    </div>
    <div class="config-options">
        <label class="checkbox-label">
            <input type="checkbox" id="extract-metadata" checked>
            <span>Extract Metadata</span>
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="generate-embeddings" checked>
            <span>Generate Embeddings</span>
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="build-graph" checked>
            <span>Build Call Graph</span>
        </label>
    </div>
</div>

<!-- Drag & Drop Zone -->
<div class="upload-zone" id="upload-zone">
    <div class="upload-icon">📁</div>
    <div class="upload-text">Drag & Drop files here</div>
    <div class="upload-subtext">or click to browse</div>
    <div class="upload-hint">Supported: .py, .js, .ts, .java, .go, .rs, .cpp, .c</div>
    <input type="file" id="file-input" multiple accept=".py,.js,.ts,.jsx,.tsx,.java,.go,.rs,.cpp,.c,.h,.hpp" style="display: none;">
</div>

<!-- File List -->
<div id="file-list" class="file-list" style="display: none;">
    <div class="list-header">
        <span class="file-count" id="file-count">0 files selected</span>
        <button class="btn-clear-files" onclick="clearFiles()">Clear All</button>
    </div>
    <div id="files-container"></div>
</div>

<!-- Upload Button -->
<div class="upload-actions" id="upload-actions" style="display: none;">
    <button class="btn btn-primary btn-upload" onclick="uploadFiles()">
        <span>🚀</span> Start Indexing
    </button>
</div>

<!-- Progress -->
<div id="upload-progress" class="upload-progress" style="display: none;">
    <div class="progress-header">
        <span class="progress-label" id="progress-label">Indexing files...</span>
        <span class="progress-percentage" id="progress-percentage">0%</span>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <!-- Timer and Current File -->
    <div class="progress-details">
        <div class="progress-detail-row">
            <span class="detail-label">Elapsed:</span>
            <span class="detail-value" id="elapsed-time">0s</span>
        </div>
        <div class="progress-detail-row">
            <span class="detail-label">Remaining:</span>
            <span class="detail-value" id="remaining-time">Calculating...</span>
        </div>
        <div class="progress-detail-row">
            <span class="detail-label">Current File:</span>
            <span class="detail-value mono" id="current-file">-</span>
        </div>
    </div>

    <!-- Pipeline Breakdown -->
    <div class="pipeline-breakdown">
        <div class="pipeline-title">Processing Pipeline</div>
        <div class="pipeline-stages">
            <div class="pipeline-stage">
                <div class="stage-icon">📝</div>
                <div class="stage-label">Parsed</div>
                <div class="stage-count" id="stage-parsed">0</div>
            </div>
            <div class="pipeline-stage">
                <div class="stage-icon">✂️</div>
                <div class="stage-label">Chunked</div>
                <div class="stage-count" id="stage-chunked">0</div>
            </div>
            <div class="pipeline-stage">
                <div class="stage-icon">🏷️</div>
                <div class="stage-label">Metadata</div>
                <div class="stage-count" id="stage-metadata">0</div>
            </div>
            <div class="pipeline-stage">
                <div class="stage-icon">🔤</div>
                <div class="stage-label">Text Embed</div>
                <div class="stage-count" id="stage-text-embed">0</div>
            </div>
            <div class="pipeline-stage">
                <div class="stage-icon">💻</div>
                <div class="stage-label">Code Embed</div>
                <div class="stage-count" id="stage-code-embed">0</div>
            </div>
            <div class="pipeline-stage">
                <div class="stage-icon">💾</div>
                <div class="stage-label">Stored</div>
                <div class="stage-count" id="stage-stored">0</div>
            </div>
            <div class="pipeline-stage">
                <div class="stage-icon">🕸️</div>
                <div class="stage-label">Graphed</div>
                <div class="stage-count" id="stage-graphed">0</div>
            </div>
        </div>
    </div>

    <!-- Counters -->
    <div class="progress-counters">
        <div class="counter-item">
            <span class="counter-label">Files:</span>
            <span class="counter-value" id="counter-files">0 / 0</span>
        </div>
        <div class="counter-item">
            <span class="counter-label">Chunks:</span>
            <span class="counter-value" id="counter-chunks">0</span>
        </div>
        <div class="counter-item">
            <span class="counter-label">Nodes:</span>
            <span class="counter-value" id="counter-nodes">0</span>
        </div>
        <div class="counter-item">
            <span class="counter-label">Edges:</span>
            <span class="counter-value" id="counter-edges">0</span>
        </div>
        <div class="counter-item error">
            <span class="counter-label">Failed:</span>
            <span class="counter-value" id="counter-failed">0</span>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity" id="recent-activity" style="display: none;">
        <div class="activity-title">Recent Activity</div>
        <div class="activity-list" id="activity-list"></div>
    </div>

    <!-- Errors -->
    <div class="progress-errors" id="progress-errors" style="display: none;">
        <div class="errors-title">Errors</div>
        <div class="errors-list" id="errors-list"></div>
    </div>
</div>

<!-- Results -->
<div id="upload-results" class="upload-results" style="display: none;"></div>

<script>
// Global state
let selectedFiles = [];

// DOM elements - initialized after DOM loads
let uploadZone, fileInput, fileList, filesContainer, fileCount;
let uploadActions, uploadProgress, uploadResults, repositoryName;

// Initialize DOM elements and event listeners after DOM loads
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    uploadZone = document.getElementById('upload-zone');
    fileInput = document.getElementById('file-input');
    fileList = document.getElementById('file-list');
    filesContainer = document.getElementById('files-container');
    fileCount = document.getElementById('file-count');
    uploadActions = document.getElementById('upload-actions');
    uploadProgress = document.getElementById('upload-progress');
    uploadResults = document.getElementById('upload-results');
    repositoryName = document.getElementById('repository-name');

    // Safety check
    if (!uploadZone || !fileInput || !uploadProgress || !uploadResults) {
        console.error('Required DOM elements not found');
        return;
    }

    // Setup Drag & Drop handlers
    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
}); // Close DOMContentLoaded

// Handle file selection
function handleFiles(files) {
    const newFiles = Array.from(files).filter(file => {
        // Filter supported extensions
        const ext = file.name.split('.').pop().toLowerCase();
        return ['py', 'js', 'ts', 'jsx', 'tsx', 'java', 'go', 'rs', 'cpp', 'c', 'h', 'hpp'].includes(ext);
    });

    selectedFiles = [...selectedFiles, ...newFiles];
    updateFileList();
}

// Update file list display
function updateFileList() {
    const fileList = document.getElementById('file-list');
    const uploadActions = document.getElementById('upload-actions');
    const fileCount = document.getElementById('file-count');
    const filesContainer = document.getElementById('files-container');

    if (!fileList || !uploadActions) return;

    if (selectedFiles.length === 0) {
        fileList.style.display = 'none';
        uploadActions.style.display = 'none';
        return;
    }

    fileList.style.display = 'block';
    uploadActions.style.display = 'block';

    if (fileCount) {
        fileCount.textContent = `${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''} selected`;
    }

    if (filesContainer) {
        filesContainer.innerHTML = selectedFiles.map((file, index) => `
            <div class="file-item">
                <span class="file-icon">📄</span>
                <span class="file-name">${file.name}</span>
                <span class="file-size">${formatBytes(file.size)}</span>
                <button class="btn-remove-file" onclick="removeFile(${index})">×</button>
            </div>
        `).join('');
    }
}

// Remove file from list
function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

// Clear all files
function clearFiles() {
    selectedFiles = [];
    updateFileList();

    const fileInput = document.getElementById('file-input');
    if (fileInput) fileInput.value = '';
}

// Format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Global variables for polling
let pollingInterval = null;
let uploadStartTime = null;

// Upload files
async function uploadFiles() {
    const repositoryName = document.getElementById('repository-name');
    const uploadActions = document.getElementById('upload-actions');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadResults = document.getElementById('upload-results');

    if (!repositoryName) {
        alert('Repository name field not found');
        return;
    }

    const repoName = repositoryName.value.trim();

    if (!repoName) {
        alert('Please enter a repository name');
        repositoryName.focus();
        return;
    }

    if (selectedFiles.length === 0) {
        alert('Please select files to upload');
        return;
    }

    // Hide actions, show progress
    if (uploadActions) uploadActions.style.display = 'none';
    if (uploadProgress) uploadProgress.style.display = 'block';
    if (uploadResults) uploadResults.style.display = 'none';

    // Reset progress UI
    resetProgressUI();

    try {
        // Read all files
        const filePromises = selectedFiles.map(file => readFile(file));
        const filesData = await Promise.all(filePromises);

        // Prepare request payload
        const commitHashEl = document.getElementById('commit-hash');
        const extractMetadataEl = document.getElementById('extract-metadata');
        const generateEmbeddingsEl = document.getElementById('generate-embeddings');
        const buildGraphEl = document.getElementById('build-graph');

        const payload = {
            repository: repoName,
            files: filesData,
            commit_hash: commitHashEl ? commitHashEl.value.trim() || null : null,
            extract_metadata: extractMetadataEl ? extractMetadataEl.checked : true,
            generate_embeddings: generateEmbeddingsEl ? generateEmbeddingsEl.checked : true,
            build_graph: buildGraphEl ? buildGraphEl.checked : true
        };

        // Send to API - now returns immediately with upload_id
        uploadStartTime = Date.now();
        const response = await fetch('/ui/code/upload/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.error || result.status === 'error') {
            throw new Error(result.error || 'Upload failed');
        }

        // Start polling for progress
        const uploadId = result.upload_id;
        startPolling(uploadId);

    } catch (error) {
        console.error('Upload error:', error);
        if (uploadProgress) uploadProgress.style.display = 'none';
        if (uploadResults) {
            uploadResults.style.display = 'block';
            uploadResults.innerHTML = `
                <div class="result-error">
                    <div class="result-icon">❌</div>
                    <div class="result-title">Upload Failed</div>
                    <div class="result-message">${error.message}</div>
                </div>
            `;
        }
    }
}

// Reset progress UI
function resetProgressUI() {
    // Helper function to safely update element
    const safeUpdate = (id, updateFn) => {
        const element = document.getElementById(id);
        if (element) updateFn(element);
    };

    safeUpdate('progress-bar', el => el.style.width = '0%');
    safeUpdate('progress-percentage', el => el.textContent = '0%');
    safeUpdate('progress-label', el => el.textContent = 'Initializing...');
    safeUpdate('elapsed-time', el => el.textContent = '0s');
    safeUpdate('remaining-time', el => el.textContent = 'Calculating...');
    safeUpdate('current-file', el => el.textContent = '-');

    // Reset pipeline stages
    ['parsed', 'chunked', 'metadata', 'text-embed', 'code-embed', 'stored', 'graphed'].forEach(stage => {
        safeUpdate(`stage-${stage}`, el => el.textContent = '0');
    });

    // Reset counters
    safeUpdate('counter-files', el => el.textContent = '0 / 0');
    safeUpdate('counter-chunks', el => el.textContent = '0');
    safeUpdate('counter-nodes', el => el.textContent = '0');
    safeUpdate('counter-edges', el => el.textContent = '0');
    safeUpdate('counter-failed', el => el.textContent = '0');

    // Hide activity and errors
    safeUpdate('recent-activity', el => el.style.display = 'none');
    safeUpdate('progress-errors', el => el.style.display = 'none');
}

// Start polling for upload status
function startPolling(uploadId) {
    // Poll every 500ms
    pollingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/ui/code/upload/status/${uploadId}`);
            const status = await response.json();

            if (status.error || status.status === 'not_found') {
                stopPolling();
                showError('Upload session not found or expired');
                return;
            }

            // Update UI with status
            updateProgressUI(status);

            // Check if complete
            if (status.status === 'completed' || status.status === 'partial' || status.status === 'error') {
                stopPolling();
                // Show final results after brief delay
                setTimeout(() => {
                    const uploadProgress = document.getElementById('upload-progress');
                    if (uploadProgress) uploadProgress.style.display = 'none';
                    showFinalResults(status);
                }, 1000);
            }

        } catch (error) {
            console.error('Polling error:', error);
            stopPolling();
            showError(`Polling failed: ${error.message}`);
        }
    }, 500);
}

// Stop polling
function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

// Update progress UI with status
function updateProgressUI(status) {
    // Helper function to safely update element
    const safeUpdate = (id, updateFn) => {
        const element = document.getElementById(id);
        if (element) updateFn(element);
    };

    // Update percentage and progress bar
    const percentage = status.percentage || 0;
    safeUpdate('progress-bar', el => el.style.width = `${percentage}%`);
    safeUpdate('progress-percentage', el => el.textContent = `${percentage}%`);

    // Update current step label
    const stepLabels = {
        'initializing': 'Initializing services...',
        'initializing_services': 'Initializing services...',
        'processing_files': 'Processing files...',
        'indexing_batch': 'Indexing batch...',
        'completed': 'Completed!'
    };
    const stepLabel = stepLabels[status.current_step] || status.current_step || 'Processing...';
    safeUpdate('progress-label', el => el.textContent = stepLabel);

    // Update timing
    const elapsedMs = status.timing?.elapsed_ms || 0;
    const elapsedSec = Math.floor(elapsedMs / 1000);
    safeUpdate('elapsed-time', el => el.textContent = formatDuration(elapsedSec));

    const remainingMs = status.timing?.estimated_remaining_ms || 0;
    if (remainingMs > 0) {
        const remainingSec = Math.floor(remainingMs / 1000);
        safeUpdate('remaining-time', el => el.textContent = formatDuration(remainingSec));
    } else {
        safeUpdate('remaining-time', el => el.textContent = '-');
    }

    // Update current file
    const currentFile = status.current_file || '-';
    safeUpdate('current-file', el => el.textContent = currentFile);

    // Update pipeline stages
    if (status.pipeline) {
        safeUpdate('stage-parsed', el => el.textContent = status.pipeline.parsed || 0);
        safeUpdate('stage-chunked', el => el.textContent = status.pipeline.chunked || 0);
        safeUpdate('stage-metadata', el => el.textContent = status.pipeline.metadata_extracted || 0);
        safeUpdate('stage-text-embed', el => el.textContent = status.pipeline.text_embedded || 0);
        safeUpdate('stage-code-embed', el => el.textContent = status.pipeline.code_embedded || 0);
        safeUpdate('stage-stored', el => el.textContent = status.pipeline.stored || 0);
        safeUpdate('stage-graphed', el => el.textContent = status.pipeline.graphed || 0);
    }

    // Update counters
    if (status.counters) {
        safeUpdate('counter-files', el => el.textContent = `${status.counters.indexed_files || 0} / ${status.total_files || 0}`);
        safeUpdate('counter-chunks', el => el.textContent = status.counters.indexed_chunks || 0);
        safeUpdate('counter-nodes', el => el.textContent = status.counters.indexed_nodes || 0);
        safeUpdate('counter-edges', el => el.textContent = status.counters.indexed_edges || 0);
        safeUpdate('counter-failed', el => el.textContent = status.counters.failed_files || 0);
    }

    // Update recent activity
    if (status.recent_files && status.recent_files.length > 0) {
        const activityDiv = document.getElementById('recent-activity');
        const activityList = document.getElementById('activity-list');

        if (activityDiv && activityList) {
            activityDiv.style.display = 'block';
            activityList.innerHTML = status.recent_files.map(f => `
                <div class="activity-item ${f.status === 'success' ? 'success' : 'error'}">
                    <span class="activity-file">${f.file}</span>
                    <span class="activity-stats">${f.chunks} chunks · ${f.time_ms}ms</span>
                </div>
            `).join('');
        }
    }

    // Update errors
    if (status.errors && status.errors.length > 0) {
        const errorsDiv = document.getElementById('progress-errors');
        const errorsList = document.getElementById('errors-list');

        if (errorsDiv && errorsList) {
            errorsDiv.style.display = 'block';
            errorsList.innerHTML = status.errors.slice(0, 10).map(err => `
                <div class="error-item-inline">
                    <span class="error-file">${err.file}:</span>
                    <span class="error-message">${err.error}</span>
                </div>
            `).join('');

            if (status.error_overflow) {
                errorsList.innerHTML += `<div class="error-overflow">... and more errors (limited to first 100)</div>`;
            }
        }
    }
}

// Format duration in seconds to human readable
function formatDuration(seconds) {
    if (seconds < 60) return `${seconds}s`;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}m ${secs}s`;
}

// Show error
function showError(message) {
    const uploadProgress = document.getElementById('upload-progress');
    const uploadResults = document.getElementById('upload-results');

    if (uploadProgress) uploadProgress.style.display = 'none';
    if (uploadResults) {
        uploadResults.style.display = 'block';
        uploadResults.innerHTML = `
            <div class="result-error">
                <div class="result-icon">❌</div>
                <div class="result-title">Upload Failed</div>
                <div class="result-message">${message}</div>
            </div>
        `;
    }
}

// Show final results
function showFinalResults(status) {
    const uploadResults = document.getElementById('upload-results');
    if (!uploadResults) return;

    uploadResults.style.display = 'block';

    const counters = status.counters || {};
    const success = status.status === 'completed';

    uploadResults.innerHTML = `
        <div class="result-${success ? 'success' : 'warning'}">
            <div class="result-icon">${success ? '✅' : '⚠️'}</div>
            <div class="result-title">${success ? 'Indexing Complete!' : 'Indexing Completed with Warnings'}</div>

            <div class="result-stats">
                <div class="stat-row">
                    <span class="stat-label">Repository:</span>
                    <span class="stat-value">${status.repository}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Indexed Files:</span>
                    <span class="stat-value">${counters.indexed_files || 0}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Code Chunks:</span>
                    <span class="stat-value">${counters.indexed_chunks || 0}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Graph Nodes:</span>
                    <span class="stat-value">${counters.indexed_nodes || 0}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Graph Edges:</span>
                    <span class="stat-value">${counters.indexed_edges || 0}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Processing Time:</span>
                    <span class="stat-value">${status.timing?.elapsed_ms?.toFixed(0) || 0} ms</span>
                </div>
                ${counters.failed_files > 0 ? `
                <div class="stat-row error">
                    <span class="stat-label">Failed Files:</span>
                    <span class="stat-value">${counters.failed_files}</span>
                </div>
                ` : ''}
            </div>

            ${status.errors && status.errors.length > 0 ? `
            <div class="result-errors">
                <div class="errors-title">Errors:</div>
                ${status.errors.slice(0, 20).map(err => `
                    <div class="error-item">${err.file}: ${err.error}</div>
                `).join('')}
                ${status.error_overflow ? '<div class="error-overflow">... and more (see logs)</div>' : ''}
            </div>
            ` : ''}

            <div class="result-actions">
                <button class="btn btn-primary" onclick="location.href='/ui/code/repos'">
                    View Repositories
                </button>
                <button class="btn btn-secondary" onclick="location.href='/ui/code/search'">
                    Search Code
                </button>
                <button class="btn btn-secondary" onclick="location.href='/ui/code/graph'">
                    View Graph
                </button>
                <button class="btn btn-clear" onclick="resetUpload()">
                    Upload More Files
                </button>
            </div>
        </div>
    `;
}

// Read file content
function readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            resolve({
                path: file.name,
                content: e.target.result,
                language: detectLanguage(file.name)
            });
        };
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

// Detect language from file extension
function detectLanguage(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const langMap = {
        'py': 'python',
        'js': 'javascript',
        'ts': 'typescript',
        'jsx': 'javascript',
        'tsx': 'typescript',
        'java': 'java',
        'go': 'go',
        'rs': 'rust',
        'cpp': 'cpp',
        'c': 'c',
        'h': 'c',
        'hpp': 'cpp'
    };
    return langMap[ext] || null;
}

// Reset upload form
function resetUpload() {
    // Stop any ongoing polling
    stopPolling();

    // Clear files
    clearFiles();

    // Hide all sections
    const uploadResults = document.getElementById('upload-results');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadActions = document.getElementById('upload-actions');

    if (uploadResults) uploadResults.style.display = 'none';
    if (uploadProgress) uploadProgress.style.display = 'none';
    if (uploadActions) uploadActions.style.display = 'none';

    // Reset progress
    resetProgressUI();
}
</script>

<style>
/* Upload Configuration */
.upload-config {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.config-row {
    margin-bottom: var(--space-md);
}

.config-label {
    display: block;
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-sm);
}

.config-input {
    width: 100%;
    padding: var(--space-md);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-primary);
    background-color: var(--color-bg-input);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
}

.config-input:focus {
    border-color: var(--color-accent-blue);
    outline: none;
}

.config-options {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border-subtle);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--color-accent-blue);
}

/* Upload Zone */
.upload-zone {
    background: var(--color-bg-secondary);
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-sm);
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
}

.upload-zone:hover,
.upload-zone.drag-over {
    border-color: var(--color-accent-blue);
    background: rgba(74, 144, 226, 0.05);
}

.upload-icon {
    font-size: 64px;
    margin-bottom: var(--space-md);
    opacity: 0.6;
}

.upload-text {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: var(--space-sm);
}

.upload-subtext {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-md);
}

.upload-hint {
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
}

/* File List */
.file-list {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-top: var(--space-xl);
}

.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border-subtle);
}

.file-count {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-accent-blue);
    text-transform: uppercase;
}

.btn-clear-files {
    padding: var(--space-xs) var(--space-md);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-danger);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition);
}

.btn-clear-files:hover {
    background: rgba(255, 71, 87, 0.1);
    border-color: var(--color-danger);
}

.file-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
}

.file-icon {
    font-size: 20px;
}

.file-name {
    flex: 1;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-primary);
    font-family: var(--font-mono);
}

.file-size {
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
}

.btn-remove-file {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 50%;
    color: var(--color-text-dim);
    font-size: 18px;
    cursor: pointer;
    transition: all var(--transition);
}

.btn-remove-file:hover {
    background: rgba(255, 71, 87, 0.1);
    border-color: var(--color-danger);
    color: var(--color-danger);
}

/* Upload Actions */
.upload-actions {
    margin-top: var(--space-xl);
    text-align: center;
}

.btn-upload {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-lg) var(--space-2xl);
    font-size: var(--text-md);
}

/* Progress */
.upload-progress {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-accent-blue);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-top: var(--space-xl);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.progress-label {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text-primary);
}

.progress-percentage {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-accent-blue);
    font-family: var(--font-mono);
}

.progress-bar-container {
    height: 8px;
    background: var(--color-bg-secondary);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--space-md);
}

.progress-bar {
    height: 100%;
    background: var(--color-accent-blue);
    transition: width 0.3s ease;
    width: 0%;
}

.progress-stats {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
}

/* Progress Details */
.progress-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
}

.progress-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.detail-label {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-text-tertiary);
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text-primary);
    font-family: var(--font-mono);
}

.detail-value.mono {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Pipeline Breakdown */
.pipeline-breakdown {
    margin-bottom: var(--space-lg);
}

.pipeline-title {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-text-tertiary);
    letter-spacing: 0.5px;
    margin-bottom: var(--space-md);
}

.pipeline-stages {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: var(--space-sm);
}

.pipeline-stage {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
    text-align: center;
    transition: all var(--transition);
}

.pipeline-stage:hover {
    border-color: var(--color-accent-blue);
    background: rgba(74, 144, 226, 0.05);
}

.stage-icon {
    font-size: 24px;
    margin-bottom: var(--space-xs);
}

.stage-label {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-xs);
}

.stage-count {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-accent-blue);
    font-family: var(--font-mono);
}

/* Progress Counters */
.progress-counters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
}

.counter-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.counter-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-tertiary);
}

.counter-value {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-accent-blue);
    font-family: var(--font-mono);
}

.counter-item.error .counter-value {
    color: var(--color-danger);
}

/* Recent Activity */
.recent-activity {
    margin-bottom: var(--space-lg);
}

.activity-title {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-text-tertiary);
    letter-spacing: 0.5px;
    margin-bottom: var(--space-md);
}

.activity-list {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-sm);
    background: var(--color-bg-panel);
    border-left: 3px solid transparent;
    border-radius: var(--radius-sm);
}

.activity-item.success {
    border-left-color: var(--color-success);
}

.activity-item.error {
    border-left-color: var(--color-danger);
}

.activity-item:last-child {
    margin-bottom: 0;
}

.activity-file {
    font-size: var(--text-xs);
    font-family: var(--font-mono);
    color: var(--color-text-secondary);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.activity-stats {
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
}

/* Progress Errors */
.progress-errors {
    margin-bottom: var(--space-lg);
}

.errors-list {
    background: rgba(255, 71, 87, 0.1);
    border: 1px solid rgba(255, 71, 87, 0.3);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
    max-height: 200px;
    overflow-y: auto;
}

.error-item-inline {
    padding: var(--space-xs) 0;
    font-size: var(--text-xs);
    font-family: var(--font-mono);
    border-bottom: 1px solid rgba(255, 71, 87, 0.2);
}

.error-item-inline:last-child {
    border-bottom: none;
}

.error-file {
    color: var(--color-danger);
    font-weight: 700;
}

.error-message {
    color: var(--color-text-secondary);
    margin-left: var(--space-xs);
}

.error-overflow {
    padding-top: var(--space-sm);
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-style: italic;
}

/* Results */
.upload-results {
    margin-top: var(--space-xl);
}

.result-success,
.result-warning,
.result-error {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-xl);
    text-align: center;
}

.result-success {
    border-left: 3px solid var(--color-success);
}

.result-warning {
    border-left: 3px solid var(--color-warning);
}

.result-error {
    border-left: 3px solid var(--color-danger);
}

.result-icon {
    font-size: 64px;
    margin-bottom: var(--space-md);
}

.result-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: var(--space-xl);
}

.result-stats {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
    text-align: left;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border-subtle);
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
}

.stat-value {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text-primary);
    font-family: var(--font-mono);
}

.stat-row.error .stat-value {
    color: var(--color-danger);
}

.result-errors {
    background: rgba(255, 71, 87, 0.1);
    border: 1px solid rgba(255, 71, 87, 0.3);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
    margin-bottom: var(--space-xl);
    text-align: left;
}

.errors-title {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-danger);
    margin-bottom: var(--space-sm);
}

.error-item {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    font-family: var(--font-mono);
    padding: var(--space-xs) 0;
}

.result-actions {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
    flex-wrap: wrap;
}

.btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
}

.btn-secondary:hover {
    background: var(--color-bg-elevated);
}
</style>
{% endblock %}
