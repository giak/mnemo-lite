{% extends "base.html" %}

{% block title %}Code Upload - MnemoLite{% endblock %}
{% block nav_code %}active{% endblock %}
{% block nav_code_upload %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üì§ Code Upload</h1>
    <p class="subtitle">Upload code files for indexing</p>
</div>

<!-- Repository Configuration -->
<div class="upload-config">
    <div class="config-row">
        <label for="repository-name" class="config-label">Repository Name *</label>
        <input type="text"
               id="repository-name"
               class="config-input"
               placeholder="my-project"
               value=""
               required>
    </div>
    <div class="config-row">
        <label for="commit-hash" class="config-label">Commit Hash (optional)</label>
        <input type="text"
               id="commit-hash"
               class="config-input"
               placeholder="abc123def456">
    </div>
    <div class="config-options">
        <label class="checkbox-label">
            <input type="checkbox" id="extract-metadata" checked>
            <span>Extract Metadata</span>
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="generate-embeddings" checked>
            <span>Generate Embeddings</span>
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="build-graph" checked>
            <span>Build Call Graph</span>
        </label>
    </div>
</div>

<!-- Drag & Drop Zone -->
<div class="upload-zone" id="upload-zone">
    <div class="upload-icon">üìÅ</div>
    <div class="upload-text">Drag & Drop files here</div>
    <div class="upload-subtext">or click to browse</div>
    <div class="upload-hint">Supported: .py, .js, .ts, .java, .go, .rs, .cpp, .c</div>
    <input type="file" id="file-input" multiple accept=".py,.js,.ts,.jsx,.tsx,.java,.go,.rs,.cpp,.c,.h,.hpp" style="display: none;">
</div>

<!-- File List -->
<div id="file-list" class="file-list" style="display: none;">
    <div class="list-header">
        <span class="file-count" id="file-count">0 files selected</span>
        <button class="btn-clear-files" onclick="clearFiles()">Clear All</button>
    </div>
    <div id="files-container"></div>
</div>

<!-- Upload Button -->
<div class="upload-actions" id="upload-actions" style="display: none;">
    <button class="btn btn-primary btn-upload" onclick="uploadFiles()">
        <span>üöÄ</span> Start Indexing
    </button>
</div>

<!-- Progress -->
<div id="upload-progress" class="upload-progress" style="display: none;">
    <div class="progress-header">
        <span class="progress-label">Indexing files...</span>
        <span class="progress-percentage" id="progress-percentage">0%</span>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="progress-stats" id="progress-stats"></div>
</div>

<!-- Results -->
<div id="upload-results" class="upload-results" style="display: none;"></div>

<script>
// Global state
let selectedFiles = [];

// DOM elements
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const fileList = document.getElementById('file-list');
const filesContainer = document.getElementById('files-container');
const fileCount = document.getElementById('file-count');
const uploadActions = document.getElementById('upload-actions');
const uploadProgress = document.getElementById('upload-progress');
const uploadResults = document.getElementById('upload-results');
const repositoryName = document.getElementById('repository-name');

// Drag & Drop handlers
uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('drag-over');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

// Handle file selection
function handleFiles(files) {
    const newFiles = Array.from(files).filter(file => {
        // Filter supported extensions
        const ext = file.name.split('.').pop().toLowerCase();
        return ['py', 'js', 'ts', 'jsx', 'tsx', 'java', 'go', 'rs', 'cpp', 'c', 'h', 'hpp'].includes(ext);
    });

    selectedFiles = [...selectedFiles, ...newFiles];
    updateFileList();
}

// Update file list display
function updateFileList() {
    if (selectedFiles.length === 0) {
        fileList.style.display = 'none';
        uploadActions.style.display = 'none';
        return;
    }

    fileList.style.display = 'block';
    uploadActions.style.display = 'block';
    fileCount.textContent = `${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''} selected`;

    filesContainer.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-item">
            <span class="file-icon">üìÑ</span>
            <span class="file-name">${file.name}</span>
            <span class="file-size">${formatBytes(file.size)}</span>
            <button class="btn-remove-file" onclick="removeFile(${index})">√ó</button>
        </div>
    `).join('');
}

// Remove file from list
function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

// Clear all files
function clearFiles() {
    selectedFiles = [];
    updateFileList();
    fileInput.value = '';
}

// Format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Upload files
async function uploadFiles() {
    const repoName = repositoryName.value.trim();

    if (!repoName) {
        alert('Please enter a repository name');
        repositoryName.focus();
        return;
    }

    if (selectedFiles.length === 0) {
        alert('Please select files to upload');
        return;
    }

    // Hide actions, show progress
    uploadActions.style.display = 'none';
    uploadProgress.style.display = 'block';
    uploadResults.style.display = 'none';

    try {
        // Read all files
        const filePromises = selectedFiles.map(file => readFile(file));
        const filesData = await Promise.all(filePromises);

        // Prepare request payload
        const payload = {
            repository: repoName,
            files: filesData,
            commit_hash: document.getElementById('commit-hash').value.trim() || null,
            extract_metadata: document.getElementById('extract-metadata').checked,
            generate_embeddings: document.getElementById('generate-embeddings').checked,
            build_graph: document.getElementById('build-graph').checked
        };

        // Send to API
        const startTime = Date.now();
        const response = await fetch('/ui/code/upload/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const duration = Date.now() - startTime;

        // Update progress to 100%
        document.getElementById('progress-bar').style.width = '100%';
        document.getElementById('progress-percentage').textContent = '100%';

        // Show results
        setTimeout(() => {
            uploadProgress.style.display = 'none';
            showResults(result, duration);
        }, 500);

    } catch (error) {
        console.error('Upload error:', error);
        uploadProgress.style.display = 'none';
        uploadResults.style.display = 'block';
        uploadResults.innerHTML = `
            <div class="result-error">
                <div class="result-icon">‚ùå</div>
                <div class="result-title">Upload Failed</div>
                <div class="result-message">${error.message}</div>
            </div>
        `;
    }
}

// Read file content
function readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            resolve({
                path: file.name,
                content: e.target.result,
                language: detectLanguage(file.name)
            });
        };
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

// Detect language from file extension
function detectLanguage(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const langMap = {
        'py': 'python',
        'js': 'javascript',
        'ts': 'typescript',
        'jsx': 'javascript',
        'tsx': 'typescript',
        'java': 'java',
        'go': 'go',
        'rs': 'rust',
        'cpp': 'cpp',
        'c': 'c',
        'h': 'c',
        'hpp': 'cpp'
    };
    return langMap[ext] || null;
}

// Show results
function showResults(result, duration) {
    uploadResults.style.display = 'block';

    if (result.error) {
        uploadResults.innerHTML = `
            <div class="result-error">
                <div class="result-icon">‚ùå</div>
                <div class="result-title">Indexing Failed</div>
                <div class="result-message">${result.error}</div>
            </div>
        `;
        return;
    }

    const success = result.failed_files === 0;
    uploadResults.innerHTML = `
        <div class="result-${success ? 'success' : 'warning'}">
            <div class="result-icon">${success ? '‚úÖ' : '‚ö†Ô∏è'}</div>
            <div class="result-title">${success ? 'Indexing Complete!' : 'Indexing Completed with Warnings'}</div>

            <div class="result-stats">
                <div class="stat-row">
                    <span class="stat-label">Repository:</span>
                    <span class="stat-value">${result.repository}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Indexed Files:</span>
                    <span class="stat-value">${result.indexed_files}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Code Chunks:</span>
                    <span class="stat-value">${result.indexed_chunks}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Graph Nodes:</span>
                    <span class="stat-value">${result.indexed_nodes}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Graph Edges:</span>
                    <span class="stat-value">${result.indexed_edges}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Processing Time:</span>
                    <span class="stat-value">${result.processing_time_ms.toFixed(0)} ms</span>
                </div>
                ${result.failed_files > 0 ? `
                <div class="stat-row error">
                    <span class="stat-label">Failed Files:</span>
                    <span class="stat-value">${result.failed_files}</span>
                </div>
                ` : ''}
            </div>

            ${result.errors && result.errors.length > 0 ? `
            <div class="result-errors">
                <div class="errors-title">Errors:</div>
                ${result.errors.map(err => `
                    <div class="error-item">${err.file}: ${err.error}</div>
                `).join('')}
            </div>
            ` : ''}

            <div class="result-actions">
                <button class="btn btn-primary" onclick="location.href='/ui/code/repos'">
                    View Repositories
                </button>
                <button class="btn btn-secondary" onclick="location.href='/ui/code/search'">
                    Search Code
                </button>
                <button class="btn btn-secondary" onclick="location.href='/ui/code/graph'">
                    View Graph
                </button>
                <button class="btn btn-clear" onclick="resetUpload()">
                    Upload More Files
                </button>
            </div>
        </div>
    `;
}

// Reset upload form
function resetUpload() {
    clearFiles();
    uploadResults.style.display = 'none';
    uploadProgress.style.display = 'none';
    uploadActions.style.display = 'none';
    document.getElementById('progress-bar').style.width = '0%';
}
</script>

<style>
/* Upload Configuration */
.upload-config {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.config-row {
    margin-bottom: var(--space-md);
}

.config-label {
    display: block;
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-sm);
}

.config-input {
    width: 100%;
    padding: var(--space-md);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-primary);
    background-color: var(--color-bg-input);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
}

.config-input:focus {
    border-color: var(--color-accent-blue);
    outline: none;
}

.config-options {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border-subtle);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--color-accent-blue);
}

/* Upload Zone */
.upload-zone {
    background: var(--color-bg-secondary);
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-sm);
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
}

.upload-zone:hover,
.upload-zone.drag-over {
    border-color: var(--color-accent-blue);
    background: rgba(74, 144, 226, 0.05);
}

.upload-icon {
    font-size: 64px;
    margin-bottom: var(--space-md);
    opacity: 0.6;
}

.upload-text {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: var(--space-sm);
}

.upload-subtext {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-md);
}

.upload-hint {
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
}

/* File List */
.file-list {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-top: var(--space-xl);
}

.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border-subtle);
}

.file-count {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-accent-blue);
    text-transform: uppercase;
}

.btn-clear-files {
    padding: var(--space-xs) var(--space-md);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-danger);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition);
}

.btn-clear-files:hover {
    background: rgba(255, 71, 87, 0.1);
    border-color: var(--color-danger);
}

.file-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
}

.file-icon {
    font-size: 20px;
}

.file-name {
    flex: 1;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-primary);
    font-family: var(--font-mono);
}

.file-size {
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-family: var(--font-mono);
}

.btn-remove-file {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 50%;
    color: var(--color-text-dim);
    font-size: 18px;
    cursor: pointer;
    transition: all var(--transition);
}

.btn-remove-file:hover {
    background: rgba(255, 71, 87, 0.1);
    border-color: var(--color-danger);
    color: var(--color-danger);
}

/* Upload Actions */
.upload-actions {
    margin-top: var(--space-xl);
    text-align: center;
}

.btn-upload {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-lg) var(--space-2xl);
    font-size: var(--text-md);
}

/* Progress */
.upload-progress {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-accent-blue);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-top: var(--space-xl);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.progress-label {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text-primary);
}

.progress-percentage {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-accent-blue);
    font-family: var(--font-mono);
}

.progress-bar-container {
    height: 8px;
    background: var(--color-bg-secondary);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--space-md);
}

.progress-bar {
    height: 100%;
    background: var(--color-accent-blue);
    transition: width 0.3s ease;
    width: 0%;
}

.progress-stats {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
}

/* Results */
.upload-results {
    margin-top: var(--space-xl);
}

.result-success,
.result-warning,
.result-error {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-xl);
    text-align: center;
}

.result-success {
    border-left: 3px solid var(--color-success);
}

.result-warning {
    border-left: 3px solid var(--color-warning);
}

.result-error {
    border-left: 3px solid var(--color-danger);
}

.result-icon {
    font-size: 64px;
    margin-bottom: var(--space-md);
}

.result-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: var(--space-xl);
}

.result-stats {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
    text-align: left;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border-subtle);
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
}

.stat-value {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text-primary);
    font-family: var(--font-mono);
}

.stat-row.error .stat-value {
    color: var(--color-danger);
}

.result-errors {
    background: rgba(255, 71, 87, 0.1);
    border: 1px solid rgba(255, 71, 87, 0.3);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
    margin-bottom: var(--space-xl);
    text-align: left;
}

.errors-title {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-danger);
    margin-bottom: var(--space-sm);
}

.error-item {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    font-family: var(--font-mono);
    padding: var(--space-xs) 0;
}

.result-actions {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
    flex-wrap: wrap;
}

.btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
}

.btn-secondary:hover {
    background: var(--color-bg-elevated);
}
</style>
{% endblock %}
