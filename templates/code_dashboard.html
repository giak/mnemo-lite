{% extends "base.html" %}

{% block title %}Code Dashboard - MnemoLite{% endblock %}
{% block nav_code %}active{% endblock %}
{% block nav_code_dashboard %}active{% endblock %}

{% block extra_head %}
<!-- Chart.js 4.4.0 (35 KB gzip) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* SCADA Industrial Code Analytics Design */

.dashboard-container {
    padding: 20px;
    min-height: calc(100vh - 180px);
}

/* Page Header */
.page-header {
    margin-bottom: 24px;
}

.page-header h1 {
    font-size: 24px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 8px 0;
    color: var(--color-text-primary);
}

.page-header .subtitle {
    font-size: 13px;
    color: var(--color-text-tertiary);
    margin: 0;
}

/* KPI Cards Grid */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.kpi-card {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-top: 3px solid var(--color-border-subtle);
    padding: 20px;
    transition: border-top-color 0.2s ease;
}

.kpi-card.repos {
    border-top-color: #667eea;
}

.kpi-card.files {
    border-top-color: #f5576c;
}

.kpi-card.functions {
    border-top-color: #00f2fe;
}

.kpi-card.complexity {
    border-top-color: #ffa502;
}

.kpi-label {
    font-size: 11px;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
    font-weight: 600;
}

.kpi-value {
    font-size: 36px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    line-height: 1;
    margin-bottom: 8px;
    color: var(--color-text-primary);
}

.kpi-unit {
    font-size: 12px;
    color: var(--color-text-tertiary);
    font-family: 'Courier New', monospace;
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
}

.chart-panel {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    padding: 0;
}

.panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg-elevated);
}

.panel-title {
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-primary);
    margin: 0;
}

.panel-body {
    padding: 20px;
}

.chart-container {
    position: relative;
    height: 280px;
}

/* Table Panel */
.table-panel {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    margin-bottom: 24px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--color-bg-elevated);
    border-bottom: 2px solid var(--color-border);
}

.data-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-tertiary);
}

.data-table tbody tr {
    border-bottom: 1px solid var(--color-border-subtle);
    transition: background 0.15s ease;
}

.data-table tbody tr:hover {
    background: var(--color-bg-elevated);
}

.data-table tbody tr:last-child {
    border-bottom: none;
}

.data-table td {
    padding: 14px 16px;
    font-size: 12px;
    color: var(--color-text-secondary);
}

.data-table td code {
    font-family: 'Courier New', monospace;
    font-size: 11px;
    background: var(--color-bg-elevated);
    padding: 2px 6px;
    border: 1px solid var(--color-border-subtle);
    color: var(--color-accent-blue);
}

.complexity-badge {
    padding: 3px 8px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    border: 1px solid;
}

.complexity-low {
    background: rgba(32, 227, 178, 0.1);
    border-color: rgba(32, 227, 178, 0.3);
    color: #20e3b2;
}

.complexity-medium {
    background: rgba(255, 165, 2, 0.1);
    border-color: rgba(255, 165, 2, 0.3);
    color: #ffa502;
}

.complexity-high {
    background: rgba(245, 87, 108, 0.1);
    border-color: rgba(245, 87, 108, 0.3);
    color: #f5576c;
}

/* Recent Activity Panel */
.activity-panel {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
}

.activity-list {
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--color-border-subtle);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: background 0.15s ease;
}

.activity-item:hover {
    background: var(--color-bg-elevated);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
}

.activity-repo {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 4px;
}

.activity-stats {
    font-size: 11px;
    color: var(--color-text-tertiary);
    font-family: 'Courier New', monospace;
}

.activity-time {
    font-size: 11px;
    color: var(--color-text-tertiary);
    font-family: 'Courier New', monospace;
    flex-shrink: 0;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--color-text-tertiary);
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--color-text-secondary);
}

.empty-state-text {
    font-size: 13px;
    margin-bottom: 20px;
}

.empty-state .btn {
    display: inline-block;
    padding: 10px 20px;
    background: var(--color-accent-blue);
    color: var(--color-bg);
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: background 0.2s ease;
}

.empty-state .btn:hover {
    background: #5a8df7;
}

/* Loading Spinner */
.loading {
    text-align: center;
    padding: 40px;
    color: var(--color-text-tertiary);
    font-size: 12px;
}

.loading::before {
    content: "‚è≥";
    font-size: 32px;
    display: block;
    margin-bottom: 12px;
}

/* Scrollbar */
.activity-list::-webkit-scrollbar {
    width: 8px;
}

.activity-list::-webkit-scrollbar-track {
    background: var(--color-bg);
}

.activity-list::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border: 1px solid var(--color-border-subtle);
}

.activity-list::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
}

/* Responsive */
@media (max-width: 1200px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>üìä Code Intelligence Dashboard</h1>
        <p class="subtitle">Analytics and overview of indexed code repositories</p>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid" id="kpi-grid">
        <div class="kpi-card repos">
            <div class="kpi-label">üì¶ Total Repositories</div>
            <div class="kpi-value" id="kpi-repos">-</div>
            <div class="kpi-unit">repositories</div>
        </div>
        <div class="kpi-card files">
            <div class="kpi-label">üìÅ Total Files</div>
            <div class="kpi-value" id="kpi-files">-</div>
            <div class="kpi-unit">files indexed</div>
        </div>
        <div class="kpi-card functions">
            <div class="kpi-label">‚ö° Total Functions</div>
            <div class="kpi-value" id="kpi-functions">-</div>
            <div class="kpi-unit">functions + classes</div>
        </div>
        <div class="kpi-card complexity">
            <div class="kpi-label">üéØ Avg Complexity</div>
            <div class="kpi-value" id="kpi-complexity">-</div>
            <div class="kpi-unit">cyclomatic</div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Language Distribution -->
        <div class="chart-panel">
            <div class="panel-header">
                <h2 class="panel-title">üåê Language Distribution</h2>
            </div>
            <div class="panel-body">
                <div class="chart-container">
                    <canvas id="language-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Complexity Distribution -->
        <div class="chart-panel">
            <div class="panel-header">
                <h2 class="panel-title">üìà Complexity Distribution</h2>
            </div>
            <div class="panel-body">
                <div class="chart-container">
                    <canvas id="complexity-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 10 Complex Functions -->
    <div class="table-panel">
        <div class="panel-header">
            <h2 class="panel-title">üî• Top 10 Most Complex Functions</h2>
        </div>
        <table class="data-table" id="complex-functions-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Function Name</th>
                    <th>File Path</th>
                    <th>Language</th>
                    <th>Complexity</th>
                    <th>Lines</th>
                </tr>
            </thead>
            <tbody id="complex-functions-body">
                <tr>
                    <td colspan="6" class="loading">Loading top functions...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Recent Indexing Activity -->
    <div class="activity-panel">
        <div class="panel-header">
            <h2 class="panel-title">üïí Recent Indexing Activity</h2>
        </div>
        <div class="activity-list" id="recent-activity">
            <div class="loading">Loading recent activity...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let languageChart = null;
let complexityChart = null;

/**
 * Load dashboard data on page load
 */
document.addEventListener('DOMContentLoaded', async function() {
    await loadDashboard();
});

/**
 * Main dashboard loader
 */
async function loadDashboard() {
    try {
        // Fetch all analytics data
        const response = await fetch('/ui/code/dashboard/data');
        const data = await response.json();

        if (data.error) {
            showError('Failed to load dashboard data: ' + data.error);
            return;
        }

        // Update KPIs
        updateKPIs(data.kpis);

        // Update charts
        updateLanguageChart(data.language_distribution);
        updateComplexityChart(data.complexity_distribution);

        // Update top functions table
        updateTopFunctionsTable(data.top_complex_functions);

        // Update recent activity
        updateRecentActivity(data.recent_activity);

    } catch (err) {
        console.error('Failed to load dashboard:', err);
        showError('Failed to load dashboard: ' + err.message);
    }
}

/**
 * Update KPI cards
 */
function updateKPIs(kpis) {
    document.getElementById('kpi-repos').textContent = kpis.total_repositories || 0;
    document.getElementById('kpi-files').textContent = kpis.total_files || 0;
    document.getElementById('kpi-functions').textContent = kpis.total_functions || 0;
    document.getElementById('kpi-complexity').textContent =
        kpis.avg_complexity ? kpis.avg_complexity.toFixed(1) : '0.0';
}

/**
 * Update language distribution pie chart
 */
function updateLanguageChart(distribution) {
    const ctx = document.getElementById('language-chart').getContext('2d');

    if (languageChart) {
        languageChart.destroy();
    }

    const labels = distribution.map(d => d.language);
    const data = distribution.map(d => d.count);
    const colors = [
        '#667eea', '#f5576c', '#00f2fe', '#ffa502', '#20e3b2',
        '#8b5cf6', '#ec4899', '#10b981', '#f59e0b', '#6366f1'
    ];

    languageChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: '#0a0e27',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#c9d1d9',
                        font: {
                            size: 11,
                            family: "'Courier New', monospace"
                        },
                        padding: 12
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(22, 27, 34, 0.95)',
                    titleColor: '#c9d1d9',
                    bodyColor: '#8b949e',
                    borderColor: '#30363d',
                    borderWidth: 1,
                    padding: 12,
                    titleFont: {
                        size: 12,
                        family: "'Courier New', monospace"
                    },
                    bodyFont: {
                        size: 11,
                        family: "'Courier New', monospace"
                    }
                }
            }
        }
    });
}

/**
 * Update complexity distribution histogram
 */
function updateComplexityChart(distribution) {
    const ctx = document.getElementById('complexity-chart').getContext('2d');

    if (complexityChart) {
        complexityChart.destroy();
    }

    // Group complexity into bins: 1-5, 6-10, 11-20, 21-50, 51+
    const bins = {
        '1-5': 0,
        '6-10': 0,
        '11-20': 0,
        '21-50': 0,
        '51+': 0
    };

    distribution.forEach(d => {
        const complexity = d.complexity;
        if (complexity >= 1 && complexity <= 5) bins['1-5'] += d.count;
        else if (complexity >= 6 && complexity <= 10) bins['6-10'] += d.count;
        else if (complexity >= 11 && complexity <= 20) bins['11-20'] += d.count;
        else if (complexity >= 21 && complexity <= 50) bins['21-50'] += d.count;
        else if (complexity > 50) bins['51+'] += d.count;
    });

    const labels = Object.keys(bins);
    const data = Object.values(bins);

    complexityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Functions',
                data: data,
                backgroundColor: [
                    '#20e3b2',
                    '#00f2fe',
                    '#ffa502',
                    '#f5576c',
                    '#8b5cf6'
                ],
                borderColor: '#0a0e27',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(22, 27, 34, 0.95)',
                    titleColor: '#c9d1d9',
                    bodyColor: '#8b949e',
                    borderColor: '#30363d',
                    borderWidth: 1,
                    padding: 12,
                    titleFont: {
                        size: 12,
                        family: "'Courier New', monospace"
                    },
                    bodyFont: {
                        size: 11,
                        family: "'Courier New', monospace"
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: '#21262d'
                    },
                    ticks: {
                        color: '#8b949e',
                        font: {
                            size: 11,
                            family: "'Courier New', monospace"
                        }
                    }
                },
                y: {
                    grid: {
                        color: '#21262d'
                    },
                    ticks: {
                        color: '#8b949e',
                        font: {
                            size: 11,
                            family: "'Courier New', monospace"
                        }
                    },
                    beginAtZero: true
                }
            }
        }
    });
}

/**
 * Update top complex functions table
 */
function updateTopFunctionsTable(functions) {
    const tbody = document.getElementById('complex-functions-body');

    if (!functions || functions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state-text">No complex functions found</td>
            </tr>
        `;
        return;
    }

    let html = '';
    functions.forEach((fn, index) => {
        const complexityClass = fn.complexity <= 10 ? 'low' : fn.complexity <= 20 ? 'medium' : 'high';
        html += `
            <tr>
                <td><strong>#${index + 1}</strong></td>
                <td><code>${fn.name || 'Unnamed'}</code></td>
                <td><span style="font-size: 11px; color: var(--color-text-tertiary);">${fn.file_path || 'Unknown'}</span></td>
                <td><span style="text-transform: uppercase; font-size: 10px; font-weight: 600; color: var(--color-accent-blue);">${fn.language || 'unknown'}</span></td>
                <td><span class="complexity-badge complexity-${complexityClass}">${fn.complexity}</span></td>
                <td>${fn.lines || '-'}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

/**
 * Update recent activity list
 */
function updateRecentActivity(activities) {
    const container = document.getElementById('recent-activity');

    if (!activities || activities.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <div class="empty-state-title">No Recent Activity</div>
                <div class="empty-state-text">Upload some code to get started</div>
                <a href="/ui/code/upload" class="btn">Upload Code</a>
            </div>
        `;
        return;
    }

    let html = '';
    activities.forEach(activity => {
        const timeAgo = formatTimeAgo(activity.last_indexed);
        html += `
            <div class="activity-item">
                <div class="activity-icon">üì¶</div>
                <div class="activity-content">
                    <div class="activity-repo">${activity.repository}</div>
                    <div class="activity-stats">
                        ${activity.file_count} files ¬∑ ${activity.chunk_count} chunks indexed
                    </div>
                </div>
                <div class="activity-time">${timeAgo}</div>
            </div>
        `;
    });

    container.innerHTML = html;
}

/**
 * Format time ago (simple version)
 */
function formatTimeAgo(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return `${Math.floor(seconds / 86400)}d ago`;
}

/**
 * Show error message
 */
function showError(message) {
    console.error(message);
    // Could integrate with ErrorHandler if available
    if (window.ErrorHandler) {
        window.ErrorHandler.showError(message);
    }
}
</script>
{% endblock %}
