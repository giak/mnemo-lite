{#
  Code Search Results Partial (HTMX Target)

  Required context variables:
  - results: List of code search result objects
  - total: Total number of results
  - query: Search query string
  - mode: Search mode (hybrid/lexical/vector)
  - metadata: Search metadata (optional)

  Usage:
    Loaded via HTMX from /ui/code/search/results
#}

{% if results and results|length > 0 %}
<div class="search-info">
    <strong>{{ total }}</strong> results found for "<em>{{ query }}</em>"
    {% if mode %}
    <span class="mode-badge">{{ mode|upper }}</span>
    {% endif %}
    {% if metadata and metadata.execution_time_ms %}
    <span class="time-badge">{{ "%.1f"|format(metadata.execution_time_ms) }} ms</span>
    {% endif %}
    <span class="keyboard-hint">üí° j/k to navigate, Enter to expand, c to copy</span>
</div>

<div class="code-list" id="code-results-container" role="feed" aria-label="Search results" aria-live="polite">
    {% for result in results %}
    {% set card_id = "code-card-" ~ loop.index0 %}
    {% set body_id = "code-body-" ~ loop.index0 %}
    <article class="code-card"
             id="{{ card_id }}"
             role="article"
             aria-labelledby="{{ card_id }}-header"
             tabindex="0"
             data-index="{{ loop.index0 }}">

        {# Card Header - Always Visible #}
        <div class="code-header" id="{{ card_id }}-header">
            <div class="code-name">
                {# Story 11.3: 3-level fallback for qualified names #}
                {% set name_path_clean = result.name_path|trim if result.name_path else None %}
                {% set name_clean = result.name|trim if result.name else None %}

                {% if name_path_clean %}
                    {# Primary: Qualified name exists #}
                    <span class="name-path"
                          title="{{ name_path_clean }}"
                          aria-label="Qualified name: {{ name_path_clean }}">
                        {{ name_path_clean }}
                    </span>
                    {% if name_path_clean != name_clean %}
                        {# Show simple name only if different #}
                        <span class="simple-name"
                              aria-label="Simple name: {{ name_clean }}">
                            ({{ name_clean }})
                        </span>
                    {% endif %}
                {% elif name_clean %}
                    {# Fallback: Simple name only #}
                    <span class="name-simple"
                          aria-label="Function name: {{ name_clean }}">
                        {{ name_clean }}
                    </span>
                {% else %}
                    {# Final fallback: Unknown #}
                    <span class="name-unknown">Unnamed</span>
                {% endif %}
            </div>

            {# EPIC-14: Type Badge (Color-coded) #}
            {% if result.metadata and result.metadata.return_type %}
                {% set return_type = result.metadata.return_type %}
                {% set badge_class = "type-badge" %}

                {# Color coding based on type complexity #}
                {% if return_type in ['int', 'str', 'float', 'bool', 'None'] %}
                    {% set badge_class = badge_class ~ " type-primitive" %}
                {% elif return_type.startswith('List[') or return_type.startswith('Dict[') or return_type.startswith('Set[') %}
                    {% set badge_class = badge_class ~ " type-collection" %}
                {% elif return_type.startswith('Optional[') %}
                    {% set badge_class = badge_class ~ " type-optional" %}
                {% else %}
                    {% set badge_class = badge_class ~ " type-complex" %}
                {% endif %}

                <span class="{{ badge_class }}"
                      aria-label="Return type: {{ return_type }}"
                      title="Return type: {{ return_type }}">
                    ‚Üí {{ return_type }}
                </span>
            {% endif %}

            {# Expand/Collapse Button #}
            <button class="expand-btn"
                    aria-expanded="true"
                    aria-controls="{{ body_id }}"
                    aria-label="Collapse details"
                    title="Click or press Enter to collapse">
                <span class="expand-icon">‚ñº</span>
            </button>
        </div>

        {# Card Body - Expanded by Default (EPIC-21 Story 21.3: Make code toggle visible) #}
        <div class="code-body"
             id="{{ body_id }}"
             aria-hidden="false">

            {# EPIC-14: LSP Type Information (if available) #}
            {% if result.metadata and (result.metadata.signature or result.metadata.param_types or result.metadata.docstring) %}
            <div class="lsp-section">
                <div class="lsp-header">
                    <span class="lsp-label">üìò Type Information</span>
                    {% if result.metadata.signature %}
                    <button class="copy-btn"
                            data-copy="{{ result.metadata.signature }}"
                            aria-label="Copy signature to clipboard"
                            title="Copy signature (shortcut: c)">
                        <span class="copy-icon">üìã</span>
                        <span class="copy-text">Copy</span>
                    </button>
                    {% endif %}
                </div>

                {% if result.metadata.signature %}
                <div class="signature-display">
                    <code class="signature">{{ result.metadata.signature }}</code>
                </div>
                {% endif %}

                {% if result.metadata.param_types %}
                <div class="param-types">
                    <strong>Parameters:</strong>
                    {% for param, param_type in result.metadata.param_types.items() %}
                    <span class="param-item">
                        <code class="param-name">{{ param }}</code>:
                        <span class="param-type type-badge type-primitive">{{ param_type }}</span>
                    </span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if result.metadata.docstring %}
                <div class="docstring">
                    <strong>Documentation:</strong>
                    <p>{{ result.metadata.docstring }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {# File Path #}
            <div class="code-path">
                üìÅ {{ result.file_path or 'Unknown' }}
                {% if result.start_line %}
                <span class="line-number">L{{ result.start_line }}</span>
                {% endif %}
            </div>

            {# Source Code Snippet - EPIC-21 Story 21.3 & 21.4: Collapsible + Copy #}
            <div class="code-snippet-container">
                <div class="code-snippet-header">
                    <button class="code-toggle-btn" onclick="toggleCodeSnippet(this)" aria-label="Expand code">
                        <span class="toggle-icon">‚ñº</span>
                        <span class="toggle-text">Show Code</span>
                    </button>
                    <button class="copy-btn code-copy-btn"
                            data-copy="{{ result.source_code|e }}"
                            aria-label="Copy code to clipboard"
                            title="Copy code (shortcut: c)">
                        <span class="copy-icon">üìã</span>
                        <span class="copy-text">Copy</span>
                    </button>
                </div>
                <div class="code-snippet collapsed">
                    <pre><code class="language-{{ result.language or 'python' }}">{{ result.source_code or '(No code content)' }}</code></pre>
                </div>
            </div>

            {# Metadata Badges #}
            <div class="code-metadata">
                <span class="badge">{{ result.language or 'unknown' }}</span>
                <span class="badge">{{ result.chunk_type or 'unknown' }}</span>

                {# Score Badge #}
                {% if result.rrf_score %}
                <span class="badge badge-score">RRF: {{ "%.3f"|format(result.rrf_score) }}</span>
                {% elif result.similarity_score %}
                <span class="badge badge-score">SIM: {{ "%.3f"|format(result.similarity_score) }}</span>
                {% elif result.similarity %}
                <span class="badge badge-score">SIM: {{ "%.3f"|format(result.similarity) }}</span>
                {% elif result.lexical_score %}
                <span class="badge badge-score">LEX: {{ "%.3f"|format(result.lexical_score) }}</span>
                {% endif %}

                {% if result.metadata %}
                    {% if result.metadata.complexity %}
                    <span class="badge">Complexity: {{ result.metadata.complexity }}</span>
                    {% endif %}
                    {% if result.metadata.lines_count %}
                    <span class="badge">Lines: {{ result.metadata.lines_count }}</span>
                    {% endif %}
                    {% if result.metadata.parameters_count is not none %}
                    <span class="badge">Params: {{ result.metadata.parameters_count }}</span>
                    {% endif %}
                {% endif %}

                {% if result.contribution %}
                    {% if result.contribution.lexical and result.contribution.lexical > 0 %}
                    <span class="badge badge-lexical">LEX: {{ "%.0f"|format(result.contribution.lexical * 100) }}%</span>
                    {% endif %}
                    {% if result.contribution.vector and result.contribution.vector > 0 %}
                    <span class="badge badge-vector">VEC: {{ "%.0f"|format(result.contribution.vector * 100) }}%</span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </article>
    {% endfor %}
</div>

{% if metadata %}
<div class="search-metadata">
    <div class="metadata-row">
        {% if metadata.lexical_enabled %}
        <span class="meta-item">
            üìù Lexical: {{ metadata.lexical_count }} results
            {% if metadata.lexical_time_ms %}
            ({{ "%.1f"|format(metadata.lexical_time_ms) }} ms)
            {% endif %}
        </span>
        {% endif %}
        {% if metadata.vector_enabled %}
        <span class="meta-item">
            üîç Vector: {{ metadata.vector_count }} results
            {% if metadata.vector_time_ms %}
            ({{ "%.1f"|format(metadata.vector_time_ms) }} ms)
            {% endif %}
        </span>
        {% endif %}
        {% if metadata.fusion_time_ms %}
        <span class="meta-item">
            ‚ö° Fusion: {{ "%.1f"|format(metadata.fusion_time_ms) }} ms
        </span>
        {% endif %}
    </div>
    {% if metadata.lexical_enabled and metadata.vector_enabled %}
    <div class="metadata-row">
        <span class="meta-item">
            ‚öñÔ∏è Weights: Lexical {{ "%.0f"|format(metadata.lexical_weight * 100) }}% / Vector {{ "%.0f"|format(metadata.vector_weight * 100) }}%
        </span>
        <span class="meta-item">
            üîó Unique after fusion: {{ metadata.unique_after_fusion }}
        </span>
    </div>
    {% endif %}
</div>
{% endif %}

{% else %}
{# EPIC-14: Enhanced Empty States with Helpful Suggestions #}
<div class="empty-state" role="status" aria-live="polite">
    <div class="empty-icon">üîç</div>
    {% if query %}
    <h3 class="empty-title">No code found matching "<em>{{ query }}</em>"</h3>
    <div class="empty-suggestions">
        <p class="empty-subtitle">Try these suggestions:</p>
        <ul class="empty-tips">
            <li>‚úì Use different keywords or synonyms</li>
            <li>‚úì Search for function/class names instead of full phrases</li>
            <li>‚úì Try hybrid search mode for better results</li>
            <li>‚úì Check if the repository has been indexed</li>
            <li>‚úì Use qualified names (e.g., "models.user.User")</li>
        </ul>
    </div>
    {% else %}
    <h3 class="empty-title">Start searching for code</h3>
    <p class="empty-subtitle">
        Enter a query above to search through indexed repositories.
        Use natural language or code patterns.
    </p>
    {% endif %}
</div>
{% endif %}

<style>
/* ============================================================
   EPIC-14 Story 14.1: Enhanced Search Results with Performance & UX
   - Card-based layout with progressive disclosure
   - Color-coded type badges
   - LSP metadata display
   - Copy-to-clipboard
   - Skeleton screens
   - Enhanced empty states
   - Keyboard navigation hints
   - ARIA accessibility
   ============================================================ */

/* Search Info Bar */
.search-info {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-accent-blue);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-lg);
    font-size: var(--text-sm);
    flex-wrap: wrap;
}

.keyboard-hint {
    margin-left: auto;
    font-size: var(--text-xs);
    color: var(--color-text-dim);
    font-style: italic;
}

.search-info strong {
    color: var(--color-accent-blue);
}

.search-info em {
    color: var(--color-text-primary);
    font-style: italic;
}

.mode-badge {
    padding: 2px 8px;
    font-size: var(--text-tiny);
    font-weight: 700;
    background: rgba(74, 144, 226, 0.12);
    border: 1px solid rgba(74, 144, 226, 0.3);
    border-radius: var(--radius-sm);
    color: var(--color-accent-blue);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.time-badge {
    padding: 2px 8px;
    font-size: var(--text-tiny);
    font-weight: 600;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-tertiary);
    font-family: 'SF Mono', Consolas, monospace;
}

/* Code List */
.code-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
}

/* ============================================================
   Card-Based Layout with Progressive Disclosure
   ============================================================ */

.code-card {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-accent-cyan);
    transition: all var(--transition);
    cursor: pointer;
}

.code-card:hover {
    border-left-color: var(--color-accent-blue);
    box-shadow: var(--shadow-sm);
}

.code-card:focus {
    outline: 2px solid var(--color-accent-blue);
    outline-offset: 2px;
}

/* Active card (currently navigated with keyboard) */
.code-card.active {
    border-left-color: var(--color-accent-blue);
    border-left-width: 4px;
    background: var(--color-bg-elevated);
}

/* Expanded card */
.code-card.expanded {
    background: var(--color-bg-elevated);
}

/* Card Header - Always Visible */
.code-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    flex-wrap: wrap;
}

.code-name {
    flex: 1;
    min-width: 0; /* Allow text truncation */
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

/* Expand/Collapse Button */
.expand-btn {
    background: transparent;
    border: 1px solid var(--color-border);
    padding: var(--space-sm) var(--space-md);
    color: var(--color-text-tertiary);
    cursor: pointer;
    transition: all var(--transition);
    font-size: var(--text-xs);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.expand-btn:hover {
    background: var(--color-bg-elevated);
    border-color: var(--color-accent-blue);
    color: var(--color-accent-blue);
}

.expand-btn:focus {
    outline: 2px solid var(--color-accent-blue);
    outline-offset: 2px;
}

.expand-icon {
    transition: transform var(--transition);
    display: inline-block;
}

.expand-btn[aria-expanded="true"] .expand-icon {
    transform: rotate(180deg);
}

/* Card Body - Collapsible */
.code-body {
    padding: 0 var(--space-md) var(--space-md) var(--space-md);
    border-top: 1px solid var(--color-border-subtle);
}

.code-body[hidden] {
    display: none;
}

/* ============================================================
   EPIC-14: Type Badges - Color-Coded
   ============================================================ */

.type-badge {
    padding: 2px 8px;
    font-size: var(--text-tiny);
    font-weight: 600;
    border: 1px solid;
    font-family: var(--font-mono);
    white-space: nowrap;
    display: inline-block;
}

/* Blue: Primitive types (int, str, float, bool, None) */
.type-primitive {
    background: rgba(74, 144, 226, 0.12);
    border-color: rgba(74, 144, 226, 0.3);
    color: #4a90e2;
}

/* Purple: Complex types (classes, custom types) */
.type-complex {
    background: rgba(156, 39, 176, 0.12);
    border-color: rgba(156, 39, 176, 0.3);
    color: #9c27b0;
}

/* Orange: Collections (List, Dict, Set) */
.type-collection {
    background: rgba(255, 152, 0, 0.12);
    border-color: rgba(255, 152, 0, 0.3);
    color: #ff9800;
}

/* Cyan: Optional types */
.type-optional {
    background: rgba(32, 227, 178, 0.12);
    border-color: rgba(32, 227, 178, 0.3);
    color: #20e3b2;
}

/* ============================================================
   EPIC-14: LSP Metadata Section
   ============================================================ */

.lsp-section {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-subtle);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
}

.lsp-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
}

.lsp-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-accent-blue);
}

/* Signature Display */
.signature-display {
    background: var(--color-bg-input);
    border: 1px solid var(--color-border);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
    overflow-x: auto;
}

.signature {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    white-space: pre-wrap;
    word-break: break-all;
}

/* Parameter Types */
.param-types {
    margin-bottom: var(--space-md);
    font-size: var(--text-sm);
}

.param-item {
    display: inline-block;
    margin-right: var(--space-md);
    margin-bottom: var(--space-sm);
}

.param-name {
    font-family: var(--font-mono);
    color: var(--color-accent-cyan);
    font-weight: 600;
}

.param-type {
    margin-left: var(--space-xs);
}

/* Docstring */
.docstring {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--leading-normal);
}

.docstring p {
    margin: var(--space-sm) 0;
}

/* ============================================================
   EPIC-14: Copy-to-Clipboard Button
   ============================================================ */

.copy-btn {
    background: transparent;
    border: 1px solid var(--color-border);
    padding: var(--space-sm) var(--space-md);
    color: var(--color-text-tertiary);
    cursor: pointer;
    transition: all var(--transition);
    font-size: var(--text-xs);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.copy-btn:hover {
    background: var(--color-bg-elevated);
    border-color: var(--color-accent-cyan);
    color: var(--color-accent-cyan);
}

.copy-btn:focus {
    outline: 2px solid var(--color-accent-cyan);
    outline-offset: 2px;
}

.copy-btn.copied {
    border-color: var(--color-ok);
    color: var(--color-ok);
}

.copy-btn.copied .copy-text::after {
    content: " ‚úì";
}

/* ============================================================
   Code Path & Snippet (Updated)
   ============================================================ */

.code-path {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-md);
    font-family: var(--font-mono);
}

.line-number {
    margin-left: var(--space-md);
    color: var(--color-accent-cyan);
    font-weight: 600;
}

.code-snippet {
    background: var(--color-bg-input);
    border: 1px solid var(--color-border);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
}

.code-snippet pre {
    margin: 0;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    line-height: var(--leading-normal);
    color: var(--color-text-primary);
    white-space: pre;
}

.code-snippet code {
    font-family: var(--font-mono);
}

/* ============================================================
   Metadata Badges (Updated)
   ============================================================ */

.code-metadata {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    align-items: center;
}

.badge {
    padding: 2px 8px;
    font-size: var(--text-tiny);
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    color: var(--color-text-tertiary);
    font-family: var(--font-mono);
}

.badge-score {
    background: rgba(74, 144, 226, 0.12);
    border-color: rgba(74, 144, 226, 0.3);
    color: #4a90e2;
    font-weight: 600;
}

/* Badge Variations */
.badge-lexical {
    background: rgba(255, 193, 7, 0.12) !important;
    border-color: rgba(255, 193, 7, 0.3) !important;
    color: #ffc107 !important;
}

.badge-vector {
    background: rgba(156, 39, 176, 0.12) !important;
    border-color: rgba(156, 39, 176, 0.3) !important;
    color: #9c27b0 !important;
}

/* Search Metadata */
.search-metadata {
    margin-top: var(--space-xl);
    padding: var(--space-md);
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-sm);
}

.metadata-row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
    margin-bottom: var(--space-sm);
}

.metadata-row:last-child {
    margin-bottom: 0;
}

.meta-item {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    font-family: 'SF Mono', Consolas, monospace;
}

/* Story 11.3: Qualified Name Display Styles */
.name-path {
    font-family: var(--font-mono);
    font-size: var(--text-md);
    color: var(--color-accent-blue);
    font-weight: 600;
    cursor: help;
    word-break: break-word;  /* Handle long paths gracefully */
}

.simple-name {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    margin-left: var(--space-md);
    font-style: italic;
}

.name-simple {
    font-family: var(--font-mono);
    font-size: var(--text-md);
    color: var(--color-accent-cyan);
    font-weight: 600;
}

.name-unknown {
    font-size: var(--text-sm);
    color: var(--color-text-dim);
    font-style: italic;
}

/* ============================================================
   EPIC-14: Enhanced Empty States
   ============================================================ */

.empty-state {
    text-align: center;
    padding: var(--space-3xl);
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: var(--space-lg);
    opacity: 0.6;
}

.empty-title {
    font-size: var(--text-lg);
    color: var(--color-text-primary);
    margin-bottom: var(--space-md);
    font-weight: 600;
}

.empty-subtitle {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-lg);
}

.empty-suggestions {
    max-width: 500px;
    margin: 0 auto;
    text-align: left;
}

.empty-tips {
    list-style: none;
    padding: 0;
    margin: var(--space-md) 0;
}

.empty-tips li {
    padding: var(--space-sm) 0;
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
}

.empty-tips li::before {
    content: "‚Üí ";
    color: var(--color-accent-cyan);
    font-weight: bold;
    margin-right: var(--space-sm);
}

/* ============================================================
   EPIC-14: Skeleton Screens (Loading States)
   ============================================================ */

.skeleton-card {
    background: var(--color-bg-panel);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-border);
    padding: var(--space-md);
    margin-bottom: var(--space-lg);
}

.skeleton-line {
    height: 16px;
    background: linear-gradient(
        90deg,
        var(--color-bg-elevated) 25%,
        var(--color-bg-panel) 50%,
        var(--color-bg-elevated) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    margin-bottom: var(--space-md);
    border-radius: var(--radius-sm);
}

.skeleton-line.short {
    width: 40%;
}

.skeleton-line.medium {
    width: 70%;
}

.skeleton-line.long {
    width: 90%;
}

@keyframes skeleton-loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Hide skeleton when results load */
.code-list:not(:empty) + .skeleton-container {
    display: none;
}

/* ============================================================
   EPIC-14: Animations for Card Expansion
   ============================================================ */

.code-body {
    animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Smooth transitions */
.code-card,
.expand-btn,
.copy-btn,
.type-badge {
    transition: all 80ms ease-out;
}

/* Focus visible (keyboard navigation) */
.code-card:focus-visible,
.expand-btn:focus-visible,
.copy-btn:focus-visible {
    outline: 2px solid var(--color-accent-blue);
    outline-offset: 2px;
}
</style>

{# EPIC-14: Skeleton Loading Template #}
<template id="skeleton-template">
    <div class="skeleton-card">
        <div class="skeleton-line short"></div>
        <div class="skeleton-line medium"></div>
        <div class="skeleton-line long"></div>
    </div>
</template>
